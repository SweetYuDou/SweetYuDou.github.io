<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>RE-NET</title>
    <url>/2024/11/01/RE-Net/</url>
    <content><![CDATA[<h3 id="ã€ŠRecurrent-Event-Network-Autoregressive-Structure-Inference-over-Temporal-Knowledge-Graphsã€‹è®ºæ–‡è§£è¯»"><a href="#ã€ŠRecurrent-Event-Network-Autoregressive-Structure-Inference-over-Temporal-Knowledge-Graphsã€‹è®ºæ–‡è§£è¯»" class="headerlink" title="ã€ŠRecurrent Event Network: Autoregressive Structure Inference over Temporal Knowledge Graphsã€‹è®ºæ–‡è§£è¯»"></a>ã€ŠRecurrent Event Network: Autoregressive Structure Inference over Temporal Knowledge Graphsã€‹è®ºæ–‡è§£è¯»</h3><h4 id="RGCN"><a href="#RGCN" class="headerlink" title="RGCN"></a>RGCN</h4><p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/15/67376238bf47b.png" alt="RGCN_formula"></p>
<p>W<sub>r</sub><sup>(l)</sup>æ˜¯æŸä¸€ä¸ªç‰¹å®šçš„å…³ç³»rï¼ˆå¦‚å¼¹åŠ¾ï¼Œä¸»åŠ¨å»ºäº¤ç­‰ï¼‰åœ¨ç¬¬lå±‚GCNä¸­çš„æƒé‡çŸ©é˜µï¼Œæ¯ä¸€ä¸ªä¸åŒçš„å…³ç³»rå¯¹åº”å…¶å¯¹åº”çš„æƒé‡çŸ©é˜µï¼Œæ¯”å¦‚r<sub>1</sub>å¯¹åº”W<sub>1</sub>è¿™æ ·</p>
<p>h<sub>o</sub><sup>(l)</sup>æ˜¯æŸä¸€ä¸ªç‰¹å®šçš„å®¢ä½“ï¼ˆobjectï¼‰åœ¨ç¬¬lå±‚GCNä¸­çš„éšè—è¡¨ç¤º&#x2F;ç‰¹å¾å‘é‡ï¼ˆhidden state&#x2F;embeddingï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“å‰så®ä½“æ‰€æŒ‡å‘çš„é‚£ä¸ªoå®¢ä½“ï¼Œ<em><strong>h<sub>s</sub><sup>(l)</sup>åŒç†</strong></em></p>
<p>W<sub>o</sub><sup>(l)</sup>æ˜¯è‡ªç¯æƒé‡çŸ©é˜µï¼Œæ„æ€å°±æ˜¯å®ƒä¼šä¸èŠ‚ç‚¹sè‡ªèº«çš„ç‰¹å¾ä¸€ç›´ç›¸ä¹˜ç„¶åæ›´æ–°åˆ°ä¸‹ä¸€å±‚å†ç»§ç»­ç›¸ä¹˜</p>
<p>N<sub>t</sub><sup>(s,r)</sup>è¡¨ç¤ºåœ¨æ—¶é—´æˆ³tï¼ˆtimestampï¼‰è¿™ä¸ªæ—¶é—´ä¸‹çš„èŠ‚ç‚¹sé€šè¿‡å…³ç³»rçš„é‚»å±…èŠ‚ç‚¹é›†åˆï¼ˆNeighborhoodï¼‰ï¼Œ<em><strong>N<sub>t</sub><sup>(s)</sup>åŒç†</strong></em></p>
<p>c<sub>s</sub>æ˜¯å½’ä¸€åŒ–å¸¸æ•°ï¼Œä½“ç°åœ¨å…¬å¼é‡Œå°±æ˜¯ï¼šnum(o) * num(r)ï¼Œå°±æ˜¯å½“å‰tçš„å®ä½“så¯¹åº”çš„å®¢ä½“oçš„ä¸ªæ•°ä¹˜ä¸Šå½“å‰tè¿™ä¸ªså¯¹åº”çš„å…³ç³»rçš„ä¸ªæ•°ï¼ŒåŒ…å«äº†å¤šå°‘ä¸ªé‚»å±…çš„ä¿¡æ¯å°±å¹³å‡æ‰ã€‚<strong>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å½“å‰tçš„å®ä½“sçš„æ‰€æœ‰é‚»å±…ä¸ªæ•°</strong></p>
<p>RGCNèšåˆå™¨çš„ä½œç”¨åœ¨äºï¼šèšåˆèŠ‚ç‚¹sçš„é‚»å±…èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚ç»“åˆå…¬å¼è§£è¯»ä¸€ä¸‹å°±æ˜¯ï¼šå¯¹äºèŠ‚ç‚¹sï¼ŒRGCNåœ¨æ›´æ–°èŠ‚ç‚¹ç‰¹å¾åŒæ—¶è€ƒè™‘<strong>èŠ‚ç‚¹è‡ªèº«çš„ç‰¹å¾</strong><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/15/67376238ab7d7.png" alt="self_loop">å’Œ<strong>å…¶é‚»å±…èŠ‚ç‚¹çš„ç‰¹å¾</strong><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/15/67376238b540f.png" alt="self_rel">ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ç±»å‹ï¼ˆæŒ‡ä¸åŒå…³ç³»å¯¹åº”ä¸åŒæƒé‡çŸ©é˜µ)ã€‚</p>
<h4 id="RGCNæ¨¡å—ä»£ç å¦‚ä¸‹ï¼š"><a href="#RGCNæ¨¡å—ä»£ç å¦‚ä¸‹ï¼š" class="headerlink" title="RGCNæ¨¡å—ä»£ç å¦‚ä¸‹ï¼š"></a>RGCNæ¨¡å—ä»£ç å¦‚ä¸‹ï¼š</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RGCNLayer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_feat, out_feat, bias=<span class="literal">None</span>, activation=<span class="literal">None</span>, self_loop=<span class="literal">False</span>, dropout=<span class="number">0.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(RGCNLayer, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.bias = bias</span><br><span class="line">        <span class="variable language_">self</span>.activation = activation</span><br><span class="line">        <span class="variable language_">self</span>.self_loop = self_loop</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.bias:</span><br><span class="line">            <span class="variable language_">self</span>.bias = nn.Parameter(torch.Tensor(out_feat))</span><br><span class="line">            nn.init.xavier_uniform_(<span class="variable language_">self</span>.bias,  gain=nn.init.calculate_gain(<span class="string">&#x27;relu&#x27;</span>))</span><br><span class="line">            <span class="comment"># xavier_uniform_ï¼šåˆå§‹åŒ–ï¼Œç”¨äºä¿è¯è¾“å…¥è¾“å‡ºçš„æ–¹å·®ç›¸åŒã€‚å¯ä»¥é¿å…éšç€å±‚æ•°çš„ä¼ é€’ï¼Œè¾“å…¥è¿‡å¤§è€Œæ¢¯åº¦æ¶ˆå¤±æˆ–è¾“å…¥è¿‡å°è€Œå¤±å»éçº¿æ€§</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æƒé‡çŸ©é˜µ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.self_loop:</span><br><span class="line">            <span class="comment"># å›ç¯æƒé‡çŸ©é˜µ</span></span><br><span class="line">            <span class="comment"># input_feature,output_feature</span></span><br><span class="line">            <span class="variable language_">self</span>.loop_weight = nn.Parameter(torch.Tensor(in_feat, out_feat))</span><br><span class="line">            nn.init.xavier_uniform_(<span class="variable language_">self</span>.loop_weight, gain=nn.init.calculate_gain(<span class="string">&#x27;relu&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dropout:</span><br><span class="line">            <span class="variable language_">self</span>.dropout = nn.Dropout(dropout)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.dropout = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">propagate</span>(<span class="params">self, g, reverse</span>):</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, g, reverse</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.self_loop:</span><br><span class="line">            <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            gæ˜¯graphï¼Œ.ndata[&#x27;h&#x27;]æ˜¯PyTorch DGLå›¾ï¼ˆGraphï¼‰å¯¹è±¡çš„ä¸€ä¸ªèŠ‚ç‚¹æ•°æ®å±æ€§ï¼Œå®ƒè¡¨ç¤ºå›¾ä¸­çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡ã€‚</span></span><br><span class="line"><span class="string">            åœ¨ GNNs ä¸­ï¼ŒèŠ‚ç‚¹ç‰¹å¾å‘é‡é€šå¸¸ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€éƒ¨åˆ†æ˜¯é™æ€çš„ç‰¹å¾ï¼Œå¦‚èŠ‚ç‚¹ç±»åˆ«ã€å±æ€§ç­‰ï¼›</span></span><br><span class="line"><span class="string">            å¦ä¸€éƒ¨åˆ†æ˜¯åŠ¨æ€çš„ç‰¹å¾ï¼Œå¦‚ä¸èŠ‚ç‚¹ç›¸é‚»çš„èŠ‚ç‚¹æ•°é‡ã€èŠ‚ç‚¹ä¹‹é—´çš„è¾¹æƒé‡ç­‰ã€‚</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span></span><br><span class="line">            loop_message = torch.mm(g.ndata[<span class="string">&#x27;h&#x27;</span>], <span class="variable language_">self</span>.loop_weight)</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.dropout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                loop_message = <span class="variable language_">self</span>.dropout(loop_message)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.propagate(g, reverse)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åº”ç”¨biasåç§»å’Œæ¿€æ´»å‡½æ•°</span></span><br><span class="line">        node_repr = g.ndata[<span class="string">&#x27;h&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.bias:</span><br><span class="line">            node_repr = node_repr + <span class="variable language_">self</span>.bias</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.self_loop:</span><br><span class="line">            node_repr = node_repr + loop_message</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.activation:</span><br><span class="line">            node_repr = <span class="variable language_">self</span>.activation(node_repr)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ›´æ–°èŠ‚ç‚¹ç‰¹å¾å‘é‡</span></span><br><span class="line">        g.ndata[<span class="string">&#x27;h&#x27;</span>] = node_repr</span><br><span class="line">        <span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RGCNBlockLayer</span>(<span class="title class_ inherited__">RGCNLayer</span>):  <span class="comment"># RGCNå—å±‚</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_feat, out_feat, num_rels, num_bases, bias=<span class="literal">None</span>, activation=<span class="literal">None</span>, self_loop=<span class="literal">False</span>, dropout=<span class="number">0.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(RGCNBlockLayer, <span class="variable language_">self</span>).__init__(in_feat, </span><br><span class="line">                                             out_feat, </span><br><span class="line">                                             bias,</span><br><span class="line">                                             activation, </span><br><span class="line">                                             self_loop=self_loop,</span><br><span class="line">                                             dropout=dropout)</span><br><span class="line">        <span class="variable language_">self</span>.num_rels = num_rels</span><br><span class="line">        <span class="variable language_">self</span>.num_bases = num_bases</span><br><span class="line">        <span class="keyword">assert</span> <span class="variable language_">self</span>.num_bases &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.out_feat = out_feat</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.submat_in = in_feat // <span class="variable language_">self</span>.num_bases</span><br><span class="line">        <span class="variable language_">self</span>.submat_out = out_feat // <span class="variable language_">self</span>.num_bases</span><br><span class="line"></span><br><span class="line">        <span class="comment"># assuming in_feat and out_feat are both divisible by num_bases</span></span><br><span class="line">        <span class="comment"># if self.num_rels == 2:</span></span><br><span class="line">        <span class="comment">#     self.in_feat = in_feat</span></span><br><span class="line">        <span class="comment">#     self.weight = nn.Parameter(torch.Tensor(</span></span><br><span class="line">        <span class="comment">#         self.num_rels, in_feat, out_feat))</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="variable language_">self</span>.weight = nn.Parameter(torch.Tensor(<span class="variable language_">self</span>.num_rels, <span class="variable language_">self</span>.num_bases * <span class="variable language_">self</span>.submat_in * <span class="variable language_">self</span>.submat_out))</span><br><span class="line">        nn.init.xavier_uniform_(<span class="variable language_">self</span>.weight, gain=nn.init.calculate_gain(<span class="string">&#x27;relu&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">msg_func</span>(<span class="params">self, edges, reverse</span>):  <span class="comment"># èŠ‚ç‚¹å’Œæƒé‡ç›¸ä¹˜ï¼Œå†è½¬åŒ–ä¸ºè¾“å‡ºæ ¼å¼</span></span><br><span class="line">        <span class="keyword">if</span> reverse:</span><br><span class="line">            <span class="comment"># edges.data[&#x27;type_o&#x27;]ï¼šè¡¨ç¤ºç›®æ ‡èŠ‚ç‚¹æ‰€å±çš„å…³ç³»çš„ç±»å‹ã€‚å…·ä½“å“ªä¸ªå…³ç³»å°±å¯¹åº”å®ƒçš„æƒé‡çŸ©é˜µ</span></span><br><span class="line">            weight = <span class="variable language_">self</span>.weight.index_select(<span class="number">0</span>, edges.data[<span class="string">&#x27;type_o&#x27;</span>]).view(-<span class="number">1</span>, <span class="variable language_">self</span>.submat_in, <span class="variable language_">self</span>.submat_out)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            weight = <span class="variable language_">self</span>.weight.index_select(<span class="number">0</span>, edges.data[<span class="string">&#x27;type_s&#x27;</span>]).view(-<span class="number">1</span>, <span class="variable language_">self</span>.submat_in, <span class="variable language_">self</span>.submat_out)</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        edges.src[&#x27;h&#x27;]ï¼šè¡¨ç¤ºæºèŠ‚ç‚¹çš„ç‰¹å¾å‘é‡ã€‚</span></span><br><span class="line"><span class="string">        å®ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º (num_nodes, submat_in) çš„tensorï¼Œå…¶ä¸­ num_nodes è¡¨ç¤ºå›¾ä¸­çš„èŠ‚ç‚¹æ•°ã€‚</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        node = edges.src[<span class="string">&#x27;h&#x27;</span>].view(-<span class="number">1</span>, <span class="number">1</span>, <span class="variable language_">self</span>.submat_in)</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        msgï¼šè¡¨ç¤ºæ¶ˆæ¯ä¼ é€’çš„ç»“æœã€‚</span></span><br><span class="line"><span class="string">        å®ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º (num_edges, out_feat) çš„tensorï¼Œå…¶ä¸­out_feat è¡¨ç¤ºè¾“å‡ºç‰¹å¾å‘é‡çš„ç»´åº¦ã€‚</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        msg = torch.bmm(node, weight).view(-<span class="number">1</span>, <span class="variable language_">self</span>.out_feat)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;msg&#x27;</span>: msg&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">propagate</span>(<span class="params">self, g, reverse</span>):</span><br><span class="line">        g.update_all(<span class="keyword">lambda</span> x: <span class="variable language_">self</span>.msg_func(x, reverse), fn.<span class="built_in">sum</span>(msg=<span class="string">&#x27;msg&#x27;</span>, out=<span class="string">&#x27;h&#x27;</span>), <span class="variable language_">self</span>.apply_func)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">apply_func</span>(<span class="params">self, nodes</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;h&#x27;</span>: nodes.data[<span class="string">&#x27;h&#x27;</span>] * nodes.data[<span class="string">&#x27;norm&#x27;</span>]&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç»“åˆä»£ç æ¥çœ‹å…¬å¼ï¼Œæ˜¯<img lazyload src="/images/loading.svg" data-src="/RE-Net/67376238ab7d7.png" alt="self_loop"></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">   		<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">         å…ˆè®©èŠ‚ç‚¹ç‰¹å¾å‘é‡ä¸è‡ªç¯æƒé‡çŸ©é˜µç›¸ä¹˜+dropout</span></span><br><span class="line"><span class="string">         &#x27;&#x27;&#x27;</span></span><br><span class="line">loop_message = torch.mm(g.ndata[<span class="string">&#x27;h&#x27;</span>], <span class="variable language_">self</span>.loop_weight)</span><br><span class="line">         <span class="keyword">if</span> <span class="variable language_">self</span>.dropout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">             loop_message = <span class="variable language_">self</span>.dropout(loop_message)</span><br><span class="line">         <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">         å†æŠŠåç§»ã€ä¹˜ç§¯ã€æ¿€æ´»å‡½æ•°åŠ åœ¨åŸæœ‰çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡ä¸Š</span></span><br><span class="line"><span class="string">         å…è®¸æ¯ä¸€å±‚éƒ½ä¿ç•™å‰ä¸€å±‚çš„ä¿¡æ¯ï¼Œæœ‰ç‚¹åƒResNetçš„æ€æƒ³</span></span><br><span class="line"><span class="string">         &#x27;&#x27;&#x27;</span></span><br><span class="line">	node_repr = g.ndata[<span class="string">&#x27;h&#x27;</span>]</span><br><span class="line">         <span class="keyword">if</span> <span class="variable language_">self</span>.bias:</span><br><span class="line">             node_repr = node_repr + <span class="variable language_">self</span>.bias</span><br><span class="line">         <span class="keyword">if</span> <span class="variable language_">self</span>.self_loop:</span><br><span class="line">             node_repr = node_repr + loop_message</span><br><span class="line">         <span class="keyword">if</span> <span class="variable language_">self</span>.activation:</span><br><span class="line">             node_repr = <span class="variable language_">self</span>.activation(node_repr)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">æŠŠæœ€åçš„èŠ‚ç‚¹è¡¨ç¤ºï¼ˆnode_reprï¼‰ä½œä¸ºè¯¥å±‚èŠ‚ç‚¹ç‰¹å¾å‘é‡çš„è¾“å‡º</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">         g.ndata[<span class="string">&#x27;h&#x27;</span>] = node_repr</span><br><span class="line">         <span class="keyword">return</span> g</span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="/RE-Net/67376238b540f.png" alt="self_rel">æ˜¯</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">def</span> <span class="title function_">msg_func</span>(<span class="params">self, edges, reverse</span>): </span><br><span class="line">      <span class="keyword">if</span> reverse:</span><br><span class="line">          weight = <span class="variable language_">self</span>.weight.index_select(<span class="number">0</span>, edges.data[<span class="string">&#x27;type_o&#x27;</span>]).view(-<span class="number">1</span>, <span class="variable language_">self</span>.submat_in, <span class="variable language_">self</span>.submat_out)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          weight = <span class="variable language_">self</span>.weight.index_select(<span class="number">0</span>, edges.data[<span class="string">&#x27;type_s&#x27;</span>]).view(-<span class="number">1</span>, <span class="variable language_">self</span>.submat_in, <span class="variable language_">self</span>.submat_out)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">å…ˆæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹æ‰€å±çš„å…³ç³»çš„ç±»å‹ï¼ˆæ¯”å¦‚ï¼šå¼¹åŠ¾ã€è¢«å¼¹åŠ¾ï¼›é€‰ä¸¾ã€è¢«é€‰ä¸¾ï¼‰</span></span><br><span class="line"><span class="string">æ‹¿åˆ°è¯¥å…³ç³»æ‰€å¯¹åº”çš„æƒé‡çŸ©é˜µ</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">      node = edges.src[<span class="string">&#x27;h&#x27;</span>].view(-<span class="number">1</span>, <span class="number">1</span>, <span class="variable language_">self</span>.submat_in)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">å°†æºèŠ‚ç‚¹çš„ç‰¹å¾å‘é‡ä¸æƒé‡ç›¸ä¹˜</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">      msg = torch.bmm(node, weight).view(-<span class="number">1</span>, <span class="variable language_">self</span>.out_feat)</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="string">&#x27;msg&#x27;</span>: msg&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">propagate</span>(<span class="params">self, g, reverse</span>):</span><br><span class="line">      g.update_all(<span class="keyword">lambda</span> x: <span class="variable language_">self</span>.msg_func(x, reverse), fn.<span class="built_in">sum</span>(msg=<span class="string">&#x27;msg&#x27;</span>, out=<span class="string">&#x27;h&#x27;</span>), <span class="variable language_">self</span>.apply_func)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">æŠŠè¯¥æºèŠ‚ç‚¹çš„æ‰€æœ‰é‚»å±…èŠ‚ç‚¹çš„msgç»“æœç›¸åŠ èšåˆ</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">apply_func</span>(<span class="params">self, nodes</span>):</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="string">&#x27;h&#x27;</span>: nodes.data[<span class="string">&#x27;h&#x27;</span>] * nodes.data[<span class="string">&#x27;norm&#x27;</span>]&#125;</span><br><span class="line">  	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  	æœ€åä¹˜ä¸Šå½’ä¸€åŒ–å¸¸æ•°nodes.data[&#x27;norm&#x27;]</span></span><br><span class="line"><span class="string">  	&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>RGCNæ•æ‰å¤šè·³é‚»å±…çš„ä¿¡æ¯ï¼šé€šè¿‡å¤šæ¬¡åº”ç”¨å›¾å·ç§¯æ“ä½œå®ç°</p>
<ul>
<li>åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹èšåˆæ¥è‡ªå…¶ç›´æ¥é‚»å±…çš„ä¿¡æ¯</li>
<li>åœ¨ç¬¬äºŒæ¬¡è¿­ä»£ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆæ¥è‡ªå…¶é‚»å±…çš„é‚»å±…ï¼ˆå³ç¬¬äºŒè·³é‚»å±…ï¼‰çš„ä¿¡æ¯</li>
</ul>
<h4 id="RE-Netæ¶æ„å›¾è§£è¯»"><a href="#RE-Netæ¶æ„å›¾è§£è¯»" class="headerlink" title="RE-Netæ¶æ„å›¾è§£è¯»"></a>RE-Netæ¶æ„å›¾è§£è¯»</h4><p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/15/67376238ebfd3.png" alt="RE-Net_architecture"></p>
<p>ä»»åŠ¡ï¼šé¢„æµ‹æ—¶é—´æˆ³tä¸­çš„ä¸‰å…ƒç»„</p>
<p>å·²çŸ¥ï¼šè¿‡å»å‡ ä¸ªæ—¶é—´æ­¥çš„å›¾ï¼ˆæ¶æ„å›¾ä¸¾ä¾‹ä¸º3ä¸ªæ—¶é—´æ­¥ï¼‰</p>
<p>RE-Net_globalå¯¹æ•´ä¸ªçŸ¥è¯†å›¾è°±ï¼ˆèƒ½è§‚å¯Ÿåˆ°çš„å›¾ï¼Œæ¶æ„å›¾ä¸­æ•´ä¸ªå›¾è°±ä¸º3ä¸ªæ—¶é—´æ­¥çš„å›¾ï¼‰è¿›è¡Œç¼–ç ï¼Œç»™å‡ºå…¨å±€åµŒå…¥è¡¨ç¤ºï¼ˆglobal_embï¼‰ã€‚åœ¨é¢„æµ‹æ—¶ç»™å‡ºé¢„æµ‹æ—¶é—´æˆ³tçš„ä¸»ä½“ã€å®¢ä½“åˆ†å¸ƒä»¥åŠæ›´æ–°åçš„å…¨å±€åµŒå…¥è¡¨ç¤º</p>
<p>RE-Net(train)ï¼šå°†å¯è§‚å¯Ÿåˆ°çš„å±€éƒ¨å›¾ä¸­çš„s,rå’Œglobal_embç­‰æ”¾å…¥Aggregatorèšåˆå™¨ï¼ˆRGCNï¼‰å½“ä¸­ï¼Œèšåˆå™¨çš„è¾“å‡ºç»“æœä¸ºä¸¤ä¸ªåºåˆ—s_packed_input,s_packed_input_råˆ†åˆ«æ”¾å…¥encoder,encoder_rä¸­ï¼Œç¼–ç å®ä½“è¡¨ç¤ºå’Œå…³ç³»è¡¨ç¤ºï¼ŒRE-Netç±»çš„self.encoderè¢«å®šä¹‰ä¸ºnn.GRUï¼Œæœ€ååˆ†åˆ«é€å…¥çº¿æ€§å±‚self.linear,self.linear_r(nn.linear)å’Œdropoutå±‚é¢„æµ‹å®¢ä½“å’Œå…³ç³»å¹¶åˆ†åˆ«è®¡ç®—æŸå¤±</p>
<p>RE-Net(valid,test)ï¼šRE-Net_globalé¢„æµ‹æ—¶é—´æˆ³tçš„ä¸»ä½“ï¼Œå®¢ä½“åˆ†å¸ƒåé‡‡æ ·å‰self.num_kä¸ªï¼Œæ›´æ–°ï¼ˆä¸»ä½“å’Œå®¢ä½“çš„åˆ—è¡¨ã€ç´¢å¼•ã€å†å²äº¤äº’ç¼“å­˜ï¼‰ï¼Œæ„å»ºæ–°çš„æ—¶é—´ç‚¹çš„å›¾ï¼Œæ›´æ–°å›¾å­—å…¸ï¼ˆgraph_dictï¼‰å’Œå…¨å±€åµŒå…¥è¡¨ç¤ºï¼ˆglobal_embï¼‰ã€‚å†é‡å¤ä»¥ä¸Šæ“ä½œâ†‘</p>
]]></content>
      <categories>
        <category>deep-learning</category>
      </categories>
      <tags>
        <tag>çŸ¥è¯†å›¾è°±</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerå­¦ä¹ ç¬”è®°</title>
    <url>/2024/11/14/Docker/</url>
    <content><![CDATA[<ul>
<li>dockeré•œåƒæºï¼ˆåŠ é€Ÿåœ°å€ï¼‰æ˜¯å›½å†…çš„æºæ¥æ‹‰é•œåƒï¼Œå¯èƒ½æœ‰ä¸€äº›é•œåƒæ²¡æœ‰ï¼Œä»£ç†å°±æ˜¯ä»Dockerhubæ‹‰ã€‚<strong>ä½ æ‹‰çš„é•œåƒå¦‚æœæ˜¯<em>Dockerhub</em>çš„ï¼Œå¹¶ä¸”å›½å†…é•œåƒæºæ²¡æœ‰ï¼Œé‚£é•œåƒæºä¹Ÿä¸å¥½ä½¿ï¼Œåªèƒ½è€è€å®å®é…å¥½ä»£ç†</strong>ã€‚é˜¿é‡Œäº‘ECSå¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿå™¨ï¼Œ<code>/etc/docker/daemon.json</code>å¦‚ä¸‹é…ç½®å³å¯ï¼Œä¸è¦åŠ å…¶ä»–æºï¼š</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://***.mirror.aliyuncs.com&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>æœ¬åœ°è®¿é—®é˜¿é‡Œäº‘ECSçš„ç½‘é¡µæ—¶ï¼Œè‹¥å‡ºç°æ— æ³•è®¿é—®çš„é—®é¢˜ï¼Œå¯ä»¥æ£€æŸ¥è¯¥ECSé…ç½®çš„å®‰å…¨ç»„æ˜¯å¦å¼€æ”¾HTTPï¼ˆ80ï¼‰ã€HTTPSï¼ˆ443ï¼‰ç«¯å£ã€‚</li>
<li>ç”¨clashæ¥ç»™æœåŠ¡å™¨<strong>é…ç½®ä»£ç†</strong>ï¼Œå¯ä»¥å‚è€ƒ<a class="link" href="https://github.com/nelvko/clash-for-linux-install?tab=readme-ov-file">nelvko&#x2F;clash-for-linux-install: ä¼˜é›…åœ°éƒ¨ç½²åŸºäº Clash çš„ä»£ç†ç¯å¢ƒ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>ï¼Œå…¶ä¸­è®¢é˜…å°±æ˜¯ä¸€ä¸ªé“¾æ¥ï¼Œå¯ä»¥ä»æœºåœºç½‘ç«™ä¸Šæ‰¾ï¼Œç±»ä¼¼è¿™æ ·çš„ï¼š</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/15/673762390d8ea.png" alt="subscription"></p>
<p>æˆ‘è¿™é‡Œç”¨çš„æ˜¯clashï¼Œå°±å¤åˆ¶clashè®¢é˜…é“¾æ¥å°±å¥½äº†ã€‚éƒ¨ç½²å®Œclashåï¼ŒæœåŠ¡å™¨å¼€æ”¾ç«¯å£7890ä½œä¸ºä»£ç†æ¥å£ï¼Œæ¥è®¿é—®ä»£ç†æœåŠ¡å™¨ã€‚åœ¨æœåŠ¡å™¨ç»ˆç«¯è®¾ç½®ç›¸å…³ç¯å¢ƒå˜é‡ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 </span><br></pre></td></tr></table></figure></div>

<p>ç”±äºé…ç½®ä»£ç†æ˜¯ä¸ºäº†dockeræœåŠ¡ï¼Œæ‰€ä»¥è¿˜è¦ç¼–è¾‘Dockerç³»ç»Ÿçš„æœåŠ¡é…ç½®æ–‡ä»¶ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class="line"><span class="built_in">sudo</span> vim /etc/systemd/system/docker.service.d/proxy.conf</span><br></pre></td></tr></table></figure></div>

<p>åœ¨proxy.confä¸­é…ç½®ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;HTTP_PROXY=http://127.0.0.1:7890&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;HTTPS_PROXY=http://127.0.0.1:7890&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>æœ€åé‡å¯dockerï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure></div>

<p>ä¸å‡ºæ„å¤–åº”è¯¥æˆåŠŸäº†ï¼Œå¯ä»¥å°è¯•æ‹‰å–ä¸€äº›ä¹‹å‰æ‹‰å–å¤±è´¥çš„é•œåƒæ¥éªŒè¯ä¸€ä¸‹</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/20/673d70d56e2f1.png" alt="traffic"></p>
<ul>
<li>é˜¿é‡Œäº‘äº‘æ•°æ®ä¼ è¾“çš„æµé‡<strong>æŒ‰é‡è®¡ç®—ï¼Œä¸¤å¤©å°±èŠ±äº†151.05CNYâ€¦TuT</strong>ï¼Œç›®å½•ä»·å› å­éƒ½æ˜¯æµå‡ºåœ°åŸŸï¼Œæˆ‘ç”¨Xftp7æŠŠECSä¸Šçš„æ–‡ä»¶ä¼ åˆ°æœ¬åœ°ä¹Ÿç”¨ä¸åˆ°100å¤šä¸ªGå§ï¼Ÿæš‚æ—¶è¿˜æ²¡æƒ³åˆ°æ˜¯ä¸ºä»€ä¹ˆï¼Œåªå¥½å…ˆæš‚åœæœåŠ¡äº†</li>
</ul>
]]></content>
      <categories>
        <category>chit-chat</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>é˜¿é‡Œäº‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Bootå­¦ä¹ ç¬”è®°</title>
    <url>/2024/11/16/Maven/</url>
    <content><![CDATA[<ul>
<li>Mavenè¿œç¨‹ä»“åº“é»˜è®¤ä¸ºMaven Central Repositoryï¼Œå¯ä»¥åœ¨<code>/conf/settings.xml</code>ä¸­é…ç½®è¿œç¨‹é•œåƒä»“åº“ä¸ºå›½å†…é˜¿é‡Œäº‘é•œåƒä»“åº“ï¼Œæé«˜JaråŒ…ä¸‹è½½çš„é€Ÿåº¦å’Œç¨³å®šæ€§ã€‚é…ç½®settings.xmlå®Œæˆåä¿å­˜é€€å‡ºã€‚</li>
</ul>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"># åœ¨settings.xml 160è¡Œå¤„æ·»åŠ é•œåƒæºï¼Œéœ€è¦ä¿è¯é•œåƒæºæ ‡ç­¾åœ¨mirrorçš„ç¬¬ä¸€ä¸ª</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/16/67377c04abc81.png" alt="image-20241116005159364">åƒè¿™æ ·ï¼Œé•œåƒæºå¾—åœ¨å‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™</p>
<ul>
<li>IntelliJ IDEAä¸­é¡¹ç›®ä»£ç è‹¥å‡ºç°æ— æ³•è§£æç¬¦å·â€œxxxâ€æŠ¥é”™ä¸”é¼ æ ‡æŒ‡é’ˆç§»åˆ°æŠ¥é”™çš„ç¬¦å·ï¼ˆè¢«é«˜äº®ä¸ºçº¢è‰²ï¼‰ä¸Šæ²¡æœ‰æç¤ºâ€å¯¼å…¥ç±»â€™xxxâ€˜æ—¶â€œï¼Œå¯ä»¥å°è¯•ç‚¹å‡»å³ä¾§â€æ›´å¤šæ“ä½œâ€œ</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/25/6743503f889cd.png" alt="æ›´å¤šæ“ä½œ"></p>
<p>ç‚¹å‡»â€œæ·»åŠ Mavenä¾èµ–é¡¹â€</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/25/6743503f852b2.png" alt="æ·»åŠ Mavenä¾èµ–é¡¹"></p>
<p>å†é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/25/6743503f5ecf4.png" alt="é€‰æ‹©åˆé€‚ç‰ˆæœ¬"></p>
<p>æœ€åå†å¯¼å…¥ç±»ï¼Œå³å¯è§£å†³æŠ¥é”™</p>
]]></content>
      <categories>
        <category>chit-chat</category>
      </categories>
      <tags>
        <tag>Maven</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>Spring Boot</tag>
        <tag>é˜¿é‡Œäº‘</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯¹FPSæ¸¸æˆä½œå¼Šå·¥å…·çš„ä¸€äº›ç†è§£</title>
    <url>/2024/11/25/DMA/</url>
    <content><![CDATA[<p>â€‹	è¿™ä¸¤å¤©çœ‹åˆ°äº†ä¸ªå‡ å¼ å›¾ç‰‡ï¼Œæ®è¯´æ˜¯è¶…è¶Šäº†DMAçš„ä½œå¼Šå·¥å…·ï¼Œçœ‹å®Œåå¿ƒè¡€æ¥æ½®æƒ³ç ”ç©¶ä¸€ä¸‹ç°åœ¨çš„ä¸€äº›æ¸¸æˆå¤–æŒ‚çš„åŸç†ã€‚</p>
<ul>
<li>é¦–å…ˆæ˜¯æ™®é€šå¤–æŒ‚è½¯ä»¶ã€‚æ¸¸æˆæ•°æ®å¤§éƒ¨åˆ†éƒ½å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œæ¯”å¦‚æ•Œäººä½ç½®ã€è¡€é‡ã€æŠ€èƒ½ç­‰ã€‚æ­£å¸¸æƒ…å†µä¸‹ä½ è‚¯å®šçœ‹ä¸åˆ°ï¼Œä½†å¤–æŒ‚è½¯ä»¶ç›´æ¥è®¿é—®æœ¬åœ°å†…å­˜ï¼Œå¹¶å°†è¿™äº›æ•°æ®å¯è§†åŒ–ã€‚æ¯”å¦‚ä¸€äº›é€è§†æŒ‚ï¼Œå°±å¯ä»¥é€šè¿‡ä»æœ¬åœ°å†…å­˜ä¸­è¯»å–çš„æ•°æ®æ¥æ˜¾ç¤ºæ•Œäººæ‰€åœ¨ä½ç½®ç­‰ä¿¡æ¯ã€‚æ¸¸æˆé€šå¸¸ä¼šæ‹’ç»è¿™äº›å¤–æŒ‚è½¯ä»¶è®¿é—®æ¸¸æˆæ•°æ®ï¼Œç¨å¾®å¥½ä¸€ç‚¹çš„å¤–æŒ‚è½¯ä»¶å°±ä¼šä¼ªè£…æˆå„ç§æ­£è§„çš„è½¯ä»¶æ¥è®¿é—®ï¼Œä½†è¿™ç§æ™®é€šçš„å†…å­˜æŒ‚åŸºæœ¬éƒ½ä¼šå°ï¼Œåªæ˜¯æ—¶é—´é—®é¢˜è€Œå·²</li>
<li>è€ŒDMAå¯ä»¥ä¼˜åŒ–è¿™ä¸€ç‚¹ã€‚DMAå…¨ç§°ä¸ºDirect Memory Accessï¼Œå³ç›´æ¥å­˜å‚¨å™¨è®¿é—®ã€‚DMAèƒ½å¤Ÿåšåˆ°<strong>åœ¨æ•°æ®ä¼ è¾“æœŸé—´</strong>è¶Šè¿‡CPUæ¥è®¿é—®å†…å­˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡DMAæŠŠæœ¬åœ°ç”µè„‘çš„å†…å­˜å¤åˆ¶ä¸€ä»½åˆ°å¦ä¸€å°ç”µè„‘ä¸Šï¼Œç„¶ååœ¨å¦ä¸€å°ç”µè„‘ä¸Šè¿è¡Œå¤–æŒ‚è½¯ä»¶æ¥å®ç°å¤–æŒ‚åŠŸèƒ½ï¼ˆå¦‚é€è§†ï¼‰ï¼Œè€Œå¤–æŒ‚è½¯ä»¶å®Œå…¨ä¸è®¿é—®è¿è¡Œåœ¨æœ¬åœ°çš„æ¸¸æˆæ•°æ®ï¼Œæ‰€ä»¥å¾ˆéš¾å°ç¦ã€‚ä½†æ˜¯ç”±äºç°ä»£æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windowsã€Linux ç­‰ï¼‰éƒ½æœ‰å¤æ‚çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚æ“ä½œç³»ç»Ÿä¼šå¯¹å†…å­˜è¿›è¡Œè™šæ‹ŸåŒ–ï¼Œå°†ç‰©ç†å†…å­˜æ˜ å°„åˆ°ä¸åŒçš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å¯¹äº DMA è®¿é—®å†…å­˜ï¼Œ<strong>DMAéœ€è¦CPUå»è§£æå†…å­˜å†ä¼ è¾“ç»™DMA</strong>ï¼Œå®ƒä¸èƒ½ç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜åœ°å€ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿå¯èƒ½å·²ç»å¯¹è¿™äº›ç‰©ç†åœ°å€è¿›è¡Œäº†é‡æ–°æ˜ å°„ã€‚å¦‚æœç›´æ¥ä½¿ç”¨ç‰©ç†åœ°å€è®¿é—®å†…å­˜ï¼Œå¯èƒ½ä¼šè®¿é—®åˆ°é”™è¯¯çš„åŒºåŸŸï¼Œå› ä¸ºå®ƒä¸çŸ¥é“æ“ä½œç³»ç»Ÿçš„å†…å­˜æ˜ å°„è§„åˆ™ã€‚å› æ­¤DMAè™½ç„¶å¯ä»¥é¿å¼€CPUï¼Œä½†ç»•ä¸è¿‡æ“ä½œç³»ç»Ÿï¼Œå­˜åœ¨è¢«æ“ä½œç³»ç»Ÿæ£€æµ‹åˆ°çš„å¯èƒ½</li>
<li>äºæ˜¯ç°åœ¨åˆæœ‰äº†HMTTæ¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚HMTTå…¨ç§°ä¸ºHybrid Memory Trace Toolï¼Œå³æ··åˆå†…å­˜è·Ÿè¸ªå·¥å…·ã€‚HMTTé€šè¿‡æ’åœ¨DDR4æ¥å£çš„å†…å­˜ä¸Šï¼Œä½¿ç”¨DIMM-snoopingæœºåˆ¶ç›‘å¬å†…å­˜æ€»çº¿ï¼Œç»•å¼€äº†CPUã€‚HMTTåœ¨è¯»å–å†…å­˜æ—¶<strong>ç³»ç»Ÿå†…éƒ¨æ²¡æœ‰ä»»ä½•ç—•è¿¹</strong>ï¼Œå¯ä»¥ç†è§£ä¸ºå†…å­˜ä¸­é—´äººï¼Œå¯ä»¥åœ¨æ•°æ®ä»ä¸€ä¸ªåœ°æ–¹ä¼ è¾“åˆ°å¦ä¸€ä¸ªåœ°æ–¹çš„è¿‡ç¨‹ä¸­ä»‹å…¥å¹¶è·å–æ•°æ®ã€‚å› æ­¤HMTTä¹Ÿå¯ä»¥åœ¨å°†å†…å­˜æ•°æ®å‘é€ç»™ä¸»æ¿å‰å¤åˆ¶ä¸€ä»½ç»™å¦ä¸€å°ç”µè„‘ï¼Œä¸”æ— æ³•è¢«æ“ä½œç³»ç»Ÿæ£€æµ‹åˆ°ã€‚HMTTæ˜¯çº¯ç‰©ç†å±‚é¢çš„è§£å†³æ–¹æ¡ˆï¼Œä¸ç»è¿‡æ“ä½œç³»ç»Ÿï¼Œå› æ­¤ä¸å­˜åœ¨æ“ä½œç³»ç»Ÿå±‚é¢çš„æ£€æµ‹å¯èƒ½â•®(â•¯â–½â•°)â•­</li>
</ul>
<p>å°†æ¥é—®ä¸–çš„å„ç§ç¡¬ä»¶å„ç§æŠ€æœ¯éš¾å…ä¼šè¢«ç”¨åœ¨ç ”å‘å¤–æŒ‚ä¸Šï¼Œè¿™æ˜¯ä¸å¯é¿å…çš„ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œå…¶å®DMAå°±å·²ç»å¾ˆéš¾æŸ¥å°äº†ï¼Œæ²¡å¿…è¦å› ä¸ºæ–°çš„å¤–æŒ‚æŠ€æœ¯è€Œæ²®ä¸§ï¼Œåæ­£åä½œå¼Šéƒ½æŸ¥ä¸å‡ºæ¥ğŸ¤£ğŸ¤£ğŸ¤£</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/26/6744b13a9bc43.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/26/6744b13a9ed3e.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2024/11/26/6744b13aa23bb.jpg"></p>
<p>è¿™ä¸‰å¼ å›¾æ˜¯æˆ‘åœ¨å†²æµªæ—¶çœ‹åˆ°çš„ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼šç¬¬ä¸€å¼ å›¾æåˆ°çš„DMAå’ŒHMTTçš„åŒºåˆ«æ˜¯æœ‰è¯¯çš„ï¼ŒDMAä¸éœ€è¦é€šè¿‡CPUæ¥è®¿é—®å†…å­˜ï¼Œç¬¬äºŒå¼ å›¾â€œDMAè·å–å†…å­˜çš„æ–¹å¼â€ä¹Ÿæ˜¯é”™çš„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¸ºäº†é”€å”®æ•…æ„è¿™æ ·åšçš„ğŸ˜</p>
]]></content>
      <categories>
        <category>chit-chat</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>DMA</tag>
        <tag>HMTT</tag>
      </tags>
  </entry>
  <entry>
    <title>VPNç­‰ç½‘ç»œä¼˜åŒ–å·¥å…·çš„ä¸€äº›ç†è§£</title>
    <url>/2024/11/30/vpn/</url>
    <content><![CDATA[<ul>
<li>VPNå…¨ç§°â€Virtual Private Networkâ€ï¼Œä¹Ÿå°±æ˜¯è™šæ‹Ÿä¸“ç”¨ç½‘ç»œã€‚VPNæä¾›å®‰å…¨çš„è¿œç¨‹è®¿é—®å’Œéšç§ä¿æŠ¤ï¼Œé€šè¿‡å»ºç«‹çš„â€œè™šæ‹Ÿéš§é“â€åœ¨å…¬ç½‘ä¸Šä¼ è¾“ï¼Œå°±åƒæ˜¯æŠŠä½ çš„æ•°æ®åŒ…è£¹åœ¨ä¸€ä¸ªæ–°çš„ â€œä¿¡å°â€ é‡Œï¼Œè¿™ä¸ª â€œä¿¡å°â€ åœ¨å…¬ç½‘ä¸Šä¼ è¾“ï¼Œåˆ°è¾¾ç›®çš„åœ°åå†æŠŠåŸå§‹æ•°æ®è§£å°è£…ã€‚</li>
</ul>
<p>â€‹	ç”¨æˆ·ä½¿ç”¨VPNè®¿é—®çš„æµç¨‹ä¸ºï¼š</p>
<ol>
<li><p>ç”¨æˆ·å…ˆé€šè¿‡VPNå®¢æˆ·ç«¯è½¯ä»¶è¿æ¥åˆ°VPNæœåŠ¡å™¨</p>
</li>
<li><p>ç”¨æˆ·çš„æ‰€æœ‰ç½‘ç»œæµé‡éƒ½ä¼šé€šè¿‡VPNæœåŠ¡å™¨è½¬å‘</p>
</li>
<li><p>VPNæœåŠ¡å™¨ä¼šå¯¹ç”¨æˆ·çš„ç½‘ç»œæ•°æ®è¿›è¡ŒåŠ å¯†,ç¡®ä¿ä¼ è¾“è¿‡ç¨‹çš„å®‰å…¨æ€§</p>
</li>
<li><p>ç”¨æˆ·çš„IPåœ°å€ä¹Ÿä¼šè¢«VPNæœåŠ¡å™¨çš„IPåœ°å€æ‰€æ›¿æ¢,ä»è€Œéšè—äº†ç”¨æˆ·çš„çœŸå®IP</p>
<p>æ‰€ä»¥åœ¨æˆ‘ä»¬ä½¿ç”¨VPNè¿›è¡Œç¿»å¢™çš„æ—¶å€™ï¼Œä¾‹å¦‚ä½¿ç”¨äº†ç¾å›½èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè®¿é—®YouTubeæ—¶å°±æ˜¯ä»¥ç¾å›½èŠ‚ç‚¹çš„IPè¿›è¡Œè®¿é—®ã€‚è€Œæ•´ä¸ªè¿‡ç¨‹ç”±äºVPNçš„åŠ å¯†ï¼Œé˜²ç«å¢™ä¸çŸ¥é“ä½ è®¿é—®äº†ä»€ä¹ˆï¼Œå› æ­¤æ— æ³•è¿›è¡Œå±è”½ï¼Œä¿éšœè®¿é—®è¿‡ç¨‹çš„é¡ºåˆ©è¿›è¡Œã€‚</p>
</li>
</ol>
<ul>
<li>æ¸¸æˆåŠ é€Ÿå™¨çš„åŸç†æ˜¯ï¼šé€šè¿‡ä¼˜åŒ–è·¯ç”±ï¼Œå‡å°‘ç½‘ç»œæ‹¥å µç­‰æ¥ä¼˜åŒ–æœåŠ¡å™¨è¿æ¥ã€‚æ¸¸æˆåŠ é€Ÿå™¨é€šå¸¸ä¼šæœ‰è‡ªå·±çš„ç½‘ç»œèŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒåœ°åŒºï¼Œé è¿‘æ¸¸æˆæœåŠ¡å™¨ã€‚å®ƒä¼šæ ¹æ®ä½ çš„ä½ç½®å’Œæ¸¸æˆæœåŠ¡å™¨ä½ç½®ï¼Œé€‰æ‹©æœ€ä¼˜çš„ç½‘ç»œä¼ è¾“è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šåˆ©ç”¨ä¸€äº›ä¸“ç”¨çš„ç½‘ç»œçº¿è·¯æˆ–è€…ä¼˜åŒ–ç½‘ç»œåè®®ï¼Œå°†ä½ çš„æ¸¸æˆæ•°æ®é€šè¿‡è¿™äº›ä¼˜åŒ–åçš„è·¯å¾„è¿›è¡Œä¼ è¾“ã€‚åŠ é€Ÿå™¨ä¼šå¯¹æ¸¸æˆæ•°æ®åŒ…è¿›è¡Œè¯†åˆ«å’Œä¼˜å…ˆå¤„ç†ï¼Œæœ‰ç‚¹åƒä¸ºæ¸¸æˆæ•°æ®å¼€è¾Ÿäº†ä¸€æ¡ â€œç»¿è‰²é€šé“â€ï¼Œä½¿æ¸¸æˆæ•°æ®èƒ½å¤Ÿæ›´å¿«åœ°ä¼ è¾“ã€‚</li>
<li>ä¸ªäººç†è§£ï¼šæ¯”å¦‚åœ¨è®¿é—®å¤–ç½‘æ—¶ï¼ŒVPNæœåŠ¡å™¨å¯ä»¥çœ‹æˆä¸€ç§è¿æ¥æ›´åŠ ç¨³å®šä¸”æ›´å®‰å…¨çš„ä»£ç†æœåŠ¡å™¨ã€‚å°±åƒclashä¸­å¯ä»¥è®¾ç½®å…¨å±€ä»£ç†å’Œæ™ºèƒ½ä»£ç†ä¸€æ ·ï¼Œå‰è€…æ˜¯å°†æ‰€æœ‰ç½‘ç»œè¯·æ±‚éƒ½é€šè¿‡ä»£ç†æœåŠ¡å™¨ï¼Œè€Œåè€…ä¼šæ ¹æ®ä½ è®¾ç½®çš„è§„åˆ™ç­‰è¿›è¡Œé€‰æ‹©æ€§åœ°ä»£ç†ã€‚</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="/vpn/67691fc6b28bf.png" alt="image-20241223163112150"></p>
]]></content>
      <categories>
        <category>chit-chat</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>vpn</tag>
      </tags>
  </entry>
  <entry>
    <title>ç³»ç»Ÿä¸­é—´ä»¶ä¸äº‘è™šæ‹ŸåŒ–å®è·µ</title>
    <url>/2025/01/13/yjs/</url>
    <content><![CDATA[<h3 id="1-åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆCodeupçš„Gitä»£ç ç®¡ç†"><a href="#1-åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆCodeupçš„Gitä»£ç ç®¡ç†" class="headerlink" title="1. åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆCodeupçš„Gitä»£ç ç®¡ç†"></a>1. åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆCodeupçš„Gitä»£ç ç®¡ç†</h3><h4 id="1-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#1-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="1.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>1.1 <strong>å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</strong></h4><p>â€¢     äº†è§£Gitå¸¸ç”¨æŒ‡ä»¤åŠå…¶åŸºæœ¬åŸç†ï¼Œå¦‚ï¼šgit push,git pull,git init,git add,git config,git branch,git commitç­‰</p>
<p>â€¢     äº†è§£ä¸€äº›å¸¸è§çš„Linuxç³»ç»Ÿå‘½ä»¤ï¼Œå¦‚ï¼šcd,cat,touchç­‰</p>
<p>â€¢     å­¦ä¼šä½¿ç”¨sshæ–¹å¼è®¿é—®ä»“åº“ï¼Œå‡å°‘ä¸å¿…è¦çš„äº¤äº’ä»¥æé«˜æ•ˆç‡</p>
<h4 id="1-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#1-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="1.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>1.2 <strong>å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</strong></h4><p>â€‹	åˆ›å»ºtest.pyæ–‡ä»¶ï¼Œæš‚å­˜è‡³æš‚å­˜åŒºåè§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼Œæäº¤è‡³æœ¬åœ°ä»“åº“åè§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼Œæ¨é€è‡³è¿œç¨‹ä»“åº“å¹¶è§‚å¯Ÿæ–‡ä»¶çŠ¶æ€</p>
<div class="highlight-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> &quot;import json&quot; &gt; test.py  #åˆ›å»ºtest.py</span><br><span class="line">git add test.py  #æš‚å­˜test.py</span><br><span class="line">git status  #è§‚å¯Ÿæ–‡ä»¶çŠ¶æ€</span><br><span class="line">git commit -m &quot;feat(test.py):å¼•å…¥json&quot;  #æäº¤è‡³æœ¬åœ°ä»“åº“</span><br><span class="line">git status  #è§‚å¯Ÿæ–‡ä»¶çŠ¶æ€</span><br><span class="line">git push origin master  #æ¨é€è‡³è¿œç¨‹ä»“åº“</span><br><span class="line">git status  #è§‚å¯Ÿæ–‡ä»¶çŠ¶æ€</span><br></pre></td></tr></table></figure></div>

<p>â€‹	è‡³æ­¤ï¼Œå·²å®Œæˆæš‚å­˜ã€æäº¤ã€æ¨é€ä¸‰ä¸ªåŸºæœ¬æ“ä½œï¼Œæœ¬åœ°ä»£ç å·²åŒæ­¥è‡³äº‘ç«¯Codeup</p>
<p>â€‹	ä¿®æ”¹test.pyæ–‡ä»¶åè§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼Œæš‚å­˜ä¿®æ”¹åçš„æ–‡ä»¶å¹¶è§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼Œæ·»åŠ <code>&quot;import re&quot;</code>è‡³<code>test.py</code>ä¸­ï¼Œè§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼Œæäº¤è‡³æœ¬åœ°ä»“åº“åè§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼Œæ¨é€è‡³äº‘ç«¯ä»“åº“åè§‚å¯Ÿæ–‡ä»¶çŠ¶æ€ï¼ŒæŸ¥çœ‹å†å²æäº¤è®°å½•</p>
<div class="highlight-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> &quot;import random&quot; &gt; test.py  #ä¿®æ­£test.py</span><br><span class="line">git status</span><br><span class="line">git add test.py</span><br><span class="line">git status</span><br><span class="line"><span class="built_in">echo</span> &quot;import re&quot; &gt;&gt; test.py</span><br><span class="line">git status</span><br><span class="line">git commit -a -m &quot;feat(test.py)ï¼šå¼•å…¥randomï¼Œre&quot;</span><br><span class="line">git status</span><br><span class="line">git push</span><br><span class="line">git status</span><br><span class="line">git log  #git logç”¨äºæŸ¥çœ‹å†å²æäº¤è®°å½• </span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹<code>test.py</code>ï¼Œæš‚å­˜æ–‡ä»¶<code>test.py</code>ï¼Œå–æ¶ˆæš‚å­˜<code>test.py</code>ï¼Œæäº¤è‡³æœ¬åœ°ä»“åº“ï¼Œæ’¤é”€æäº¤ï¼Œå†æ¬¡æäº¤è‡³æœ¬åœ°ä»“åº“ï¼Œæ¨é€è‡³äº‘ç«¯ä»“åº“ï¼Œæœ¬åœ°å›æ»šåå†æ¬¡å¼ºè¡Œæ¨é€è‡³è¿œç¨‹ä»“åº“ï¼ŒæœŸé—´ä¸æ–­<code>git status</code>è§‚å¯Ÿæ–‡ä»¶çŠ¶æ€</p>
<div class="highlight-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> &quot;<span class="built_in">print</span>(&#x27;Hello world&#x27;)&quot; &gt;&gt; test.py</span><br><span class="line">git status</span><br><span class="line">git add test.py</span><br><span class="line">git status</span><br><span class="line">git <span class="built_in">restore</span> --staged test.py  #å°†æœ¬åœ°ä»“åº“HEADæŒ‡å‘çš„ç‰ˆæœ¬å¤åˆ¶åˆ°æš‚å­˜åŒº</span><br><span class="line">git status</span><br><span class="line">git add test.py</span><br><span class="line">git reset HEAD test.py</span><br><span class="line">git commit -m &quot;feat(test.py)ï¼šæ‰“å°Hello World&quot;</span><br><span class="line">git status</span><br><span class="line">git reset HEAD~  #HEAD~æ˜¯HEADçš„çˆ¶èŠ‚ç‚¹ï¼Œè®¾ç½®HEADæŒ‡å‘å½“å‰æäº¤çš„ä¸Šä¸€æ¬¡æäº¤</span><br><span class="line">git status</span><br><span class="line">git commit -a -m &quot;feat(test.py)ï¼šæ‰“å°Hello World&quot;</span><br><span class="line">git push origin master</span><br><span class="line">git reset HEAD~</span><br><span class="line">git push -f origin master</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å–æ¶ˆå¯¹<code>test.py</code>çš„è·Ÿè¸ªå¹¶æ¢å¤ï¼Œä¸æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹å‰çš„<code>test.py</code>è¿›è¡Œæ¯”è¾ƒï¼Œæš‚å­˜<code>test.py</code>è‡³æš‚å­˜åŒºï¼Œåˆ é™¤<code>test.py</code>ï¼ŒæŸ¥çœ‹<code>test.py</code>çš„å†…å®¹ï¼Œä»æš‚å­˜åŒºä¸­æ¢å¤<code>test.py</code>ï¼ŒæŸ¥çœ‹test.pyå†…å®¹ï¼Œåˆ é™¤<code>test.py</code>ï¼Œå†å¼ºåˆ¶åˆ é™¤å·²æš‚å­˜çš„<code>test.py</code>ï¼Œå°è¯•æ¢å¤è¢«åˆ é™¤çš„æ–‡ä»¶ï¼ŒæŸ¥çœ‹<code>test.py</code>æ˜¯å¦è¢«æ¢å¤ï¼Œä»æš‚å­˜åŒºä¸­æ¢å¤<code>test.py</code>ï¼ŒæŸ¥çœ‹<code>test.py</code>çš„å†…å®¹</p>
<div class="highlight-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="code"><pre><span class="line">Plain Text</span><br><span class="line">git rm --cached test.py  #å–æ¶ˆå¯¹test.pyçš„è·Ÿè¸ª</span><br><span class="line">git status</span><br><span class="line">git add test.py</span><br><span class="line">git diff test.py</span><br><span class="line">git status</span><br><span class="line">git add test.py</span><br><span class="line">git status</span><br><span class="line">rm test.py  #åˆ é™¤test.py</span><br><span class="line">cat test.py  #åœ¨ç»ˆç«¯ä¸­æ‰“å°test.pyçš„å†…å®¹</span><br><span class="line">git status</span><br><span class="line">git <span class="built_in">restore</span> test.py</span><br><span class="line">cat test.py</span><br><span class="line">git status</span><br><span class="line">git rm test.py</span><br><span class="line">git rm -f test.py</span><br><span class="line">git status</span><br><span class="line">git <span class="built_in">restore</span> test.py</span><br><span class="line">git <span class="built_in">restore</span> --staged test.py</span><br><span class="line">git status</span><br><span class="line">git <span class="built_in">restore</span> test.py</span><br><span class="line">cat test.py</span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/13/6783edb9378ba.png" alt="img"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/13/6783edb8d428c.png" alt="img"></p>
<h4 id="1-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#1-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="1.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>1.3 <strong>é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</strong></h4><p>â€‹	è¯¥å®éªŒæš‚æœªé‡åˆ°é—®é¢˜</p>
<h3 id="2-åŸºäºé˜¿é‡Œäº‘-ECS-ä¸-ACR-çš„å®¹å™¨é•œåƒç®¡ç†"><a href="#2-åŸºäºé˜¿é‡Œäº‘-ECS-ä¸-ACR-çš„å®¹å™¨é•œåƒç®¡ç†" class="headerlink" title="2. åŸºäºé˜¿é‡Œäº‘ ECS ä¸ ACR çš„å®¹å™¨é•œåƒç®¡ç†"></a>2. åŸºäºé˜¿é‡Œäº‘ ECS ä¸ ACR çš„å®¹å™¨é•œåƒç®¡ç†</h3><h4 id="2-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#2-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="2.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>2.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     æŒæ¡ECSçš„åŸºæœ¬æ“ä½œï¼Œèƒ½è¾ƒä¸ºç†Ÿç»ƒåœ°ä½¿ç”¨Linuxå¹³å°ï¼Œå¦‚ECSè¿œç¨‹è¿æ¥ï¼ŒXftp 7ä¼ è¾“æ–‡ä»¶ç­‰</p>
<p>â€¢     æŒæ¡Dockerçš„å¸¸ç”¨å‘½ä»¤ï¼ŒåŒ…æ‹¬æ‹‰å–é•œåƒï¼Œå¯åŠ¨å®¹å™¨ï¼ŒæŸ¥çœ‹é•œåƒï¼Œåˆ é™¤é•œåƒï¼Œæš‚åœå®¹å™¨ç­‰</p>
<p>â€¢     å­¦ä¼šæ’°å†™Dockerfileæ–‡ä»¶æ¥æ„å»ºé•œåƒï¼Œå¹¶åŸºäºé˜¿é‡Œäº‘ACRå®Œæˆé•œåƒçš„pullå’Œpush</p>
<h4 id="2-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#2-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="2.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>2.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>â€‹	ä½¿ç”¨<code>docker pull</code>æ‹‰å–<code>nginx</code>é•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>docker images</code>æŸ¥çœ‹å·²æ‹‰å–çš„é•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>docker run</code>è¿è¡Œ<code>docker</code>å®¹å™¨</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name nginx -p 80:80 nginx</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨docker psæŸ¥çœ‹å½“å‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker ps  </span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ­¤æ—¶å¯ç”¨æœ¬åœ°æµè§ˆå™¨è®¿é—®è¯¥ECSæœåŠ¡å™¨å…¬ç½‘ï¼Œå³<code>http://&lt;ECSå…¬ç½‘IP&gt;</code>ä»¥æ­¤éªŒè¯å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/13/6785313586e43.jpg" alt="img"></p>
<p>â€‹	å°†NginxæœåŠ¡çš„é…ç½®æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶åŠWebæœåŠ¡çš„æ ¹ç›®å½•åˆ†åˆ«å»ºç«‹æŒä¹…åŒ–æ˜ å°„ï¼Œå¯ä»¥ç†è§£ä¸ºè®©å®¹å™¨ä¸­çš„ç›®å½•ä¸å®¿ä¸»ç›®å½•è¿›è¡ŒåŒæ­¥</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/nginx/conf.d</span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/nginx/logs</span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/nginx/html</span><br><span class="line"><span class="comment"># -p --parentsï¼šå¦‚æœè·¯å¾„ä¸­ä»»æ„ä¸€çº§çˆ¶ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">cp</span> nginx:/etc/nginx/nginx.conf /opt/docker/nginx/</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/etc/nginx/conf.d /opt/docker/nginx/</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/usr/share/nginx/html /opt/docker/nginx/</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ç°åœ¨è¦æƒ³NginxæœåŠ¡ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨çš„æ•°æ®ï¼Œéœ€è¦å…ˆåœæ­¢å†åˆ é™¤å½“å‰è¿è¡Œçš„nginxå®¹å™¨</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop nginx</span><br><span class="line">docker <span class="built_in">rm</span> nginx</span><br><span class="line">docker ps -a <span class="comment">#è§‚å¯Ÿæ˜¯å¦åˆ é™¤æˆåŠŸ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	é‡æ–°æ‰§è¡Œ<code>docker run</code>ï¼ŒåŒæ—¶é…ç½®å¥½ç›¸å…³å‚æ•°</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -v, --volume listï¼šæŒ‚åœ¨ç›®å½•ï¼Œ&lt;å®¿ä¸»ç›®å½•&gt;:&lt;å®¹å™¨ç›®å½•&gt;</span></span><br><span class="line">docker run -d --restart=always \</span><br><span class="line">            --name nginx \</span><br><span class="line">            -p 80:80 \</span><br><span class="line">            -v /opt/docker/nginx/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">            -v /opt/docker/nginx/html:/usr/share/nginx/html \</span><br><span class="line">            -v /opt/docker/nginx/logs:/var/log/nginx \</span><br><span class="line">            nginx</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>docker stop</code>,<code>docker start</code>è¿›è¡Œç»ƒä¹ </p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop nginx</span><br><span class="line">docker start nginx</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>curl</code>å‘½ä»¤è·å–ç½‘é¡µå†…å®¹</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">curl 127.0.0.1:80  <span class="comment">#åœ¨ECSç»ˆç«¯ä¸Šè¾“å…¥ï¼Œæ‰€ä»¥åœ°å€æ˜¯127.0.0.1</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>docker exec</code>å‘½ä»¤è¿›å…¥å®¹å™¨ã€‚è¯¥å‘½ä»¤å®šä¹‰ä¸ºåœ¨å®¹å™¨å†…éƒ¨è¿è¡Œä¸€æ¡æŒ‡å®šå‘½ä»¤ï¼Œå¯ä»¥æŒ‡å®šå‘½ä»¤ä¸ºShellç¨‹åºï¼Œå¦‚<code>/bin/bash</code>ï¼Œé…åˆå‚æ•°<code>-it</code>ï¼Œå¯ä»¥å®ç°è¿›å…¥å®¹å™¨è¿›è¡Œå‘½ä»¤è¡Œäº¤äº’å¼æ“ä½œ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx /bin/bash</span><br><span class="line"><span class="comment"># -i --interactiveï¼Œä¿æŒäº¤äº’æ¨¡å¼</span></span><br><span class="line"><span class="comment"># -t --ttyï¼Œåˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ï¼ˆæ¨¡æ‹Ÿç»ˆç«¯ï¼‰</span></span><br><span class="line"><span class="comment"># nginxï¼Œå®¹å™¨åç§°</span></span><br><span class="line"><span class="comment"># /bin/bashï¼Œå¾…æ‰§è¡Œçš„å‘½ä»¤ï¼Œè¿›å…¥bash shell</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	è¿›å…¥å®¹å™¨åï¼Œåœ¨nginxæœåŠ¡çš„WebæœåŠ¡çš„æ ¹ç›®å½•ä¸­åˆ›å»º<code>test.html</code>æ–‡ä»¶ã€‚ç”±äºå®¹å™¨æœ¬èº«ä¸æ”¯æŒ<code>vim</code>ï¼Œå› æ­¤ç”¨<code>echo</code>å‘½ä»¤è¿›è¡Œç¼–å†™ï¼Œæœ€åç”¨<code>exit</code>å‘½ä»¤é€€å‡ºå®¹å™¨</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;Hello,world&lt;/h1&gt;&quot;</span> &gt; test.html</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">ls</span> /opt/docker/nginx/html  <span class="comment">#æŸ¥çœ‹æ˜¯å¦æˆåŠŸæŒä¹…åŒ–å‚¨å­˜åˆ°å®¿ä¸»ç³»ç»Ÿ</span></span><br><span class="line">curl 127.0.0.1:80/test.html  </span><br></pre></td></tr></table></figure></div>

<p>â€‹	é™¤äº†curlå‘½ä»¤ï¼Œä¸€æ ·å¯ä»¥ç”¨æµè§ˆå™¨è®¿é—®<code>http://&lt;ECSå…¬ç½‘åœ°å€&gt;/test.html</code>æ¥éªŒè¯</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/13/6785313522372.jpg" alt="img"></p>
<p>â€‹	ä½¿ç”¨<code>docker logs</code>æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•æ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs nginx</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>dcoker rmi</code>åˆ é™¤ä¸å¿…è¦çš„å®¹å™¨é•œåƒæ—¶ï¼Œè¦å…ˆåˆ é™¤ä½¿ç”¨è¯¥é•œåƒçš„å®¹å™¨ï¼Œæƒ³åˆ é™¤å®¹å™¨åˆå¾—å…ˆåœæ­¢å®¹å™¨å®ä¾‹è¿è¡Œã€‚æ•…åˆ é™¤é•œåƒçš„é¡ºåºå¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop nginx</span><br><span class="line">docker <span class="built_in">rm</span> nginx</span><br><span class="line">docker rmi nginx</span><br><span class="line">docker images  <span class="comment">#åˆ¤æ–­é•œåƒæ˜¯å¦åˆ é™¤æˆåŠŸ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ„å»ºDockerå®¹å™¨é•œåƒå¯ä»¥é€šè¿‡ç¼–å†™å¹¶è¿è¡ŒDockerfileæ–‡ä»¶æ¥å®ç°ï¼Œä¸€èˆ¬è€Œè¨€ï¼ŒDockerfileçš„æ–‡ä»¶æŒ‡ä»¤é€»è¾‘åº”æŒ‰ç…§ä»¥ä¸‹æ¨¡å¼å»ºç«‹ï¼šé€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒã€å®‰è£…åŸºç¡€å·¥å…·ä¸ä¾èµ–ã€æ·»åŠ å…¶ä»–åº”ç”¨ã€æ¸…ç†ç¼“å­˜ã€å£°æ˜é•œåƒç«¯å£æš´éœ²æƒ…å†µã€è®¾ç½®é»˜è®¤å¯åŠ¨å‘½ä»¤</p>
<div class="highlight-container" data-rel="Dockerfile"><figure class="iseeu highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨Ubuntuä½œä¸ºåŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">22.04</span></span><br><span class="line"><span class="comment"># ç»´æŠ¤è€…ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;&lt;yud0u@qq.com&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…nginxåŠPython</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    nginx \</span></span><br><span class="line"><span class="language-bash">    python3 \</span></span><br><span class="line"><span class="language-bash">    python3-distutils</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†aptè½¯ä»¶åŒ…ç¼“å­˜    </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å£°æ˜æš´éœ²ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾ç½®å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash">[<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨docker buildå‘½ä»¤åˆ›å»ºå®¹å™¨é•œåƒï¼ˆæœ€å¥½åœ¨DockerfileåŒä¸€ç›®å½•ä¸‹è¿è¡Œï¼‰</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -t, tagï¼šé•œåƒåç§°ï¼ˆREPOSITORYï¼šTAGï¼‰</span></span><br><span class="line"><span class="comment"># npuï¼šNginx Python Ubuntuï¼Œè‡ªå®šä¹‰é•œåƒåç§°</span></span><br><span class="line"><span class="comment"># .ï¼šPATHï¼Œæ‰§è¡Œå‘½ä»¤çš„ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œæ„é€ è¿‡ç¨‹ä¸­å¯ä»¥å¼•ç”¨è¯¥ä¸Šä¸‹æ–‡ä¸­çš„ä»»ä½•æ–‡ä»¶</span></span><br><span class="line">docker build -t npu .</span><br><span class="line">docker images  <span class="comment">#æŸ¥çœ‹é•œåƒæ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	è¿è¡Œè¯¥é•œåƒï¼Œæ£€æµ‹NginxæœåŠ¡ï¼›è¿›å…¥å®¹å™¨åæ£€æµ‹Pythonè§£æèƒ½åŠ›</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name npu -p 80:80 npu</span><br><span class="line">curl 127.0.0.1</span><br><span class="line">docker <span class="built_in">exec</span> -it npu /bin/bash</span><br><span class="line">(nginx)python3</span><br><span class="line"><span class="built_in">exit</span>()</span><br><span class="line">(nginx)<span class="built_in">exit</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å°†åˆ›å»ºçš„npué•œåƒæ¨é€è‡³ACRï¼Œåœ¨æ­¤ä¹‹å‰å…ˆåœ¨ACRæ§åˆ¶å°åˆ›å»ºé•œåƒä»“åº“<code>npu</code></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker login --username=é±¼è±†YuDou crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com</span><br><span class="line">docker tag [ImageId] crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/npu:[é•œåƒç‰ˆæœ¬å·]</span><br><span class="line">docker push crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/npu:[é•œåƒç‰ˆæœ¬å·]</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ¨é€æˆåŠŸåå¯ä»¥åœ¨è¯¥é•œåƒä»“åº“ä¸­æŸ¥çœ‹æäº¤è®°å½•</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/13/678531347f773.jpg" alt="img"></p>
<p>â€‹	ä»ACRä¸­æ‹‰å–å®¹å™¨é•œåƒè¿›è¡Œæµ‹è¯•ï¼Œéœ€è¦å…ˆåˆ é™¤æœ¬åœ°å®¹å™¨åŠå…¶é•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop npu</span><br><span class="line">docker <span class="built_in">rm</span> npu</span><br><span class="line">docker rmi npu</span><br><span class="line">docker rmi crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/npu</span><br><span class="line">docker images  <span class="comment">#æŸ¥çœ‹é•œåƒæ˜¯å¦åˆ é™¤æˆåŠŸ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	åˆ é™¤åå†è¿›è¡Œæ‹‰å–æ“ä½œï¼Œå¹¶è¿›è¡Œæµ‹è¯•</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/npu:latest</span><br><span class="line">docker run -d --name npu -p 80:80 crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/npu:latest</span><br><span class="line">curl 127.0.0.1  <span class="comment">#æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</span></span><br></pre></td></tr></table></figure></div>

<h4 id="2-4-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#2-4-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="2.4 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>2.4 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p>â€‹	<strong>ï¼ˆâœ…ï¼‰æœ¬å®éªŒé‡åˆ°çš„æœ€å¤§é—®é¢˜ä¸ºï¼šdockeræ‹‰å–é•œåƒè¶…æ—¶ã€‚</strong></p>
<p>â€‹	ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œå…±å°è¯•äº†ä¸‰ç§æ–¹æ³•ï¼š</p>
<ol>
<li>ï¼ˆâŒï¼‰åœ¨<code>/etc/docker/daemon.json</code>ä¸‹é…ç½®dockeré•œåƒæºï¼ŒåŒ…æ‹¬å„ç§åä¸ºäº‘ç­‰é•œåƒæºï¼Œé…ç½®æ–¹æ³•å‚è€ƒä»¥ä¸‹é“¾æ¥<a class="link" href="https://blog.csdn.net/weixin_50160384/article/details/139861337%EF%BC%8C%E4%BD%86%E5%9D%87%E4%BB%A5%E5%A4%B1%E8%B4%A5%E5%91%8A%E7%BB%88">https://blog.csdn.net/weixin_50160384/article/details/139861337ï¼Œä½†å‡ä»¥å¤±è´¥å‘Šç»ˆ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>ï¼ˆâŒï¼‰åœ¨<code>/etc/docker/daemon.json</code>ä¸‹é…ç½®é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿå™¨ï¼Œåœ¨ACRä¸­è·å–åŠ é€Ÿå™¨åœ°å€ï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼é…ç½®ï¼Œä¸æ·»åŠ å…¶ä»–é•œåƒæºï¼Œä½†æ•ˆæœå¹¶ä¸ç¨³å®šï¼Œæœ‰æ—¶å¯ä»¥æ‹‰å–æˆåŠŸæœ‰æ—¶åˆä¸è¡Œ</li>
</ol>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;https://***.mirror.aliyuncs.com&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/13/67853134866b3.png" alt="image-20250113233043464"></p>
<ol start="3">
<li>ï¼ˆâœ…ï¼‰ä¸ºECSæœåŠ¡å™¨é…ç½®ä»£ç†ï¼Œåœ¨ç½‘ä¸Šé˜…è¯»äº†è®¸å¤šæ–‡ç« åï¼Œæˆ‘å°†å…·ä½“æ–¹æ³•æ€»ç»“åœ¨æˆ‘çš„ä¸ªäººåšå®¢ä¸Šï¼š<a class="link" href="https://sweetyudou.github.io/2024/11/14/Docker/%E3%80%82%E7%AE%80%E8%80%8C%E8%A8%80%E4%B9%8B%EF%BC%8C%E6%88%91%E4%BD%BF%E7%94%A8clash%E6%88%90%E5%8A%9F%E4%B8%BAECS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%88%90%E5%8A%9F%E5%81%9A%E5%88%B0%E4%BA%86%E7%A8%B3%E5%AE%9A%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%EF%BC%8C%E6%98%AF%E4%B8%80%E5%8A%B3%E6%B0%B8%E9%80%B8%E7%9A%84%E5%A5%BD%E6%96%B9%E6%B3%95">https://sweetyudou.github.io/2024/11/14/Docker/ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä½¿ç”¨clashæˆåŠŸä¸ºECSæœåŠ¡å™¨é…ç½®ä»£ç†ï¼Œå¹¶ä¸”æˆåŠŸåšåˆ°äº†ç¨³å®šæ‹‰å–é•œåƒï¼Œæ˜¯ä¸€åŠ³æ°¸é€¸çš„å¥½æ–¹æ³• <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
</ol>
<h3 id="3-åŸºäºé˜¿é‡Œäº‘ECSä¸ACRçš„Pythonå¾®æœåŠ¡é•œåƒæ„å»ºã€éƒ¨ç½²ä¸æ¥å£è®¿é—®"><a href="#3-åŸºäºé˜¿é‡Œäº‘ECSä¸ACRçš„Pythonå¾®æœåŠ¡é•œåƒæ„å»ºã€éƒ¨ç½²ä¸æ¥å£è®¿é—®" class="headerlink" title="3. åŸºäºé˜¿é‡Œäº‘ECSä¸ACRçš„Pythonå¾®æœåŠ¡é•œåƒæ„å»ºã€éƒ¨ç½²ä¸æ¥å£è®¿é—®"></a>3. åŸºäºé˜¿é‡Œäº‘ECSä¸ACRçš„Pythonå¾®æœåŠ¡é•œåƒæ„å»ºã€éƒ¨ç½²ä¸æ¥å£è®¿é—®</h3><h4 id="3-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#3-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="3.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>3.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     æŒæ¡Dockerfileæ„å»ºå®¹å™¨é•œåƒ</p>
<p>â€¢     ç†è§£HTTPåè®®åŸºæœ¬æ¦‚å¿µï¼ŒæŒæ¡HTTPè°ƒè¯•å·¥å…·çš„ä½¿ç”¨</p>
<p>â€¢     ç†è§£ç½‘ç»œæœåŠ¡APIçš„æ¦‚å¿µï¼Œå­¦ä¼šHTTP RESTful APIçš„ä½¿ç”¨</p>
<p>â€¢     ç†è§£å¹¶æŒæ¡Python Requests</p>
<h4 id="3-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#3-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="3.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>3.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/exp_pyms_api_demo">exp_pyms_api_demo <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	åœ¨ACRä¸­åˆ›å»ºé•œåƒä»“åº“ï¼Œä»¥å¤‡åç»­çš„é•œåƒä¸Šä¼ </p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/14/67866bd496fbd.png" alt="img"></p>
<p>â€‹	å¯åŠ¨æœ¬å®éªŒæä¾›çš„å¾®æœåŠ¡èŒƒä¾‹ï¼Œä½“éªŒHTTP RESTful APIæ¥å£ï¼Œæœ¬æœåŠ¡èŒƒä¾‹åœ¨8000ç«¯å£ç›‘å¬ï¼Œå¯åŠ¨å‘½ä»¤ä¸ºï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">./exp_pyms_api_demo ./device.csv</span><br><span class="line"><span class="comment"># ./exp_pyms_api_demo &lt;csv_file&gt;,csv_fileä¸ºå­˜å‚¨è®¾å¤‡ä¿¡æ¯çš„CSVæ–‡ä»¶è·¯å¾„ã€‚è‹¥è¯¥è·¯å¾„ä¸­å­˜åœ¨CSVæ–‡ä»¶åˆ™è¯»å–ä¿¡æ¯ï¼Œå¦åˆ™è‡ªåŠ¨åˆ›å»º5æ¡è®¾å¤‡ä¿¡æ¯å¹¶ç”ŸæˆCSVæ–‡ä»¶</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ­¤æ—¶è®¿é—®<code>http://&lt;IP&gt;:8000/docs</code>å°†ä¼šçœ‹åˆ°ä»¥ä¸‹é¡µé¢ï¼š</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/14/67866aeab506c.png" alt="image-20250114213605484"></p>
<p>â€‹	æ­¤æ—¶å½“å‰ç›®å½•åˆ›å»º<code>device.csv</code>æ–‡ä»¶ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -F  <span class="comment">#æŸ¥çœ‹æ˜¯å¦åˆ›å»ºdevice.csvæ–‡ä»¶</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	<code>Ctrl + C</code>é€€å‡ºç¨‹åºåï¼Œåˆ›å»ºDockerfileæ–‡ä»¶</p>
<div class="highlight-container" data-rel="Dockerfile"><figure class="iseeu highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨Ubuntu 22.04 ä½œä¸ºåŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">22.04</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;&lt;yud0u@qq.com&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå·¥ä½œç›®å½•ä¸º /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="comment">#å°†ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­çš„ exp_pyms_api_demo å¤åˆ¶åˆ°é•œåƒä¸­</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> exp_pyms_api_demo exp_pyms_api_demo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²æœåŠ¡ç«¯å£ 8000</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå®¹å™¨çš„å¯åŠ¨å‘½ä»¤ï¼Œdevcie.csv å°†å­˜å‚¨åœ¨å®¹å™¨çš„/var/lib/exp_pyms_data/ ç›®å½•ä¸‹ï¼Œå› æ­¤è¯¥ç›®å½•åº”æŒä¹…åŒ–</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/app/exp_pyms_api_demo&quot;</span>, <span class="string">&quot;/var/lib/exp_pyms_data/device.csv&quot;</span>]</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>docker build</code>å‘½ä»¤æ„å»ºå®¹å™¨é•œåƒï¼Œé•œåƒåä¸º<code>exp_pyms_api_demo:1.0</code></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t exp_pyms_api_demo:1.0 .</span><br><span class="line">docker images  <span class="comment">#æŸ¥çœ‹é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å°†é•œåƒä¸Šä¼ è‡³ACRé•œåƒä»“åº“</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker login --username=é±¼è±†YuDou crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com</span><br><span class="line">docker tag [ImageId] crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/exp_pyms_api_demo:[é•œåƒç‰ˆæœ¬å·]</span><br><span class="line">docker push crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/exp_pyms_api_demo:[é•œåƒç‰ˆæœ¬å·]</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ¨é€æˆåŠŸåï¼Œå¯åœ¨é•œåƒä»“åº“exp_pyms_api_demoçš„é¡µé¢ä¸­æŸ¥çœ‹åˆšåˆšæ¨é€çš„é•œåƒ</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/14/67866aedac18f.gif" alt="img"></p>
<p>â€‹	è¿œç¨‹ç™»å½•ECSå¹¶æ‹‰å–é•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/exp_pyms_api_demo:[é•œåƒç‰ˆæœ¬å·]</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åœ¨ECSå·¥ä½œç›®å½•åˆ›å»ºæŒä¹…åŒ–ç›®å½•exp_pyms_dataï¼Œç”¨äºå­˜å‚¨å®¹å™¨å†…æœåŠ¡ç”Ÿæˆçš„ä¸šåŠ¡æ•°æ®æ–‡æ¡£ï¼Œå³è®¾å¤‡ä¿¡æ¯æ•°æ®ï¼Œéšåè¿è¡Œè¯¥é•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> exp_pyms_data</span><br><span class="line">docker run -d --restart=always\</span><br><span class="line">            --name exp_pyms_api_demo \</span><br><span class="line">            -v ./exp_pyms_data/:/var/lib/exp_pyms_data/ \</span><br><span class="line">            -p 8000:8000 \</span><br><span class="line">            crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/exp_pyms_api_demo:1.0</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨docker logsæŸ¥çœ‹æœåŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs exp_pyms_api_demo  </span><br><span class="line"><span class="built_in">ls</span> exp_pyms_data/  <span class="comment">#è‹¥æœ‰device.csvæ–‡ä»¶ï¼Œåˆ™æˆåŠŸåˆ›å»º5æ¡è®¾å¤‡ä¿¡æ¯ä¸”æœåŠ¡æˆåŠŸè¿è¡Œ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨OpenAPIæŸ¥çœ‹å¾®æœåŠ¡æ¥å£ï¼Œåœ¨æµè§ˆå™¨ä¸­é€šè¿‡<code>&lt;ecs_ip&gt;:8000/docs</code>æ¥è®¿é—®<code>Redocly</code>æ–‡æ¡£åœ°å€</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/14/67866ae867e7a.jpg" alt="img"></p>
<p>â€‹	åŒç†ï¼Œæœ¬å®éªŒSwaggeræ–‡æ¡£åœ°å€ä¸º<code>&lt;ecs_ip&gt;:8000/docs/swagger</code></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/14/67866ae9278db.jpg" alt="img"></p>
<p>â€‹	é…ç½®Pythonè™šæ‹Ÿç¯å¢ƒ<code>exp_venv</code></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m venv exp_venv</span><br><span class="line"><span class="built_in">source</span> exp_venv/bin/activate</span><br><span class="line">pip install requests</span><br></pre></td></tr></table></figure></div>

<p>â€‹	è¿›å…¥Pythonäº¤äº’å¼ç•Œé¢è¿›è¡Œåˆæ­¥éªŒè¯</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">python3</span><br><span class="line">import requests  <span class="comment">#éªŒè¯requestsåº“æ˜¯å¦å¯å¯¼å…¥</span></span><br><span class="line">requests.__version__  <span class="comment">#æŸ¥çœ‹requestsç‰ˆæœ¬</span></span><br><span class="line"><span class="built_in">exit</span>()</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æŸ¥çœ‹å…ˆå‰ç”Ÿæˆçš„device.csvæ–‡ä»¶å†…å®¹ï¼Œé€šè¿‡Requestsåº“è®¿é—®æ¥å£æ¥è·å–è®¾å¤‡ä¿¡æ¯</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> exp_pyms_data/device.csv</span><br><span class="line">python3</span><br><span class="line">import requests</span><br><span class="line">resp = requests.get(<span class="string">&quot;http://&lt;ecs_ip&gt;:8000/v1/devices&quot;</span>,json=&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;6713124465&quot;</span>&#125;)  <span class="comment">#é€šè¿‡idæ¥æ£€ç´¢è®¾å¤‡å¹¶è·å–ä¿¡æ¯ï¼Œè¯¥idä¸ºéšæœºç”Ÿæˆçš„ä¾‹å­</span></span><br><span class="line">resp</span><br><span class="line">resp.status_code  <span class="comment">#æŸ¥çœ‹çŠ¶æ€ç åˆ¤æ–­è®¿é—®æ˜¯å¦æˆåŠŸï¼Œè®¿é—®æˆåŠŸçš„HTTPçŠ¶æ€ç ä¸º200</span></span><br><span class="line">resp.text</span><br><span class="line">resp.json()</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åŒæ—¶è¿˜æ”¯æŒç”¨â€œåºå·SN-ç±»å‹â€æ¥æ£€ç´¢è®¾å¤‡</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">resp = requests.get(<span class="string">&quot;http://&lt;ecs_ip&gt;:8000/v1/devices&quot;</span>, json=&#123;<span class="string">&quot;sn&quot;</span>: <span class="string">&quot;XRmiI&quot;</span>, <span class="string">&quot;model&quot;</span>: <span class="string">&quot;Raspberry Pi 4&quot;</span>&#125;)  <span class="comment">#è¯¥ç»„åˆä¿¡æ¯ä¸ºéšæœºç”Ÿæˆçš„ä¾‹å­</span></span><br><span class="line">resp.status_code</span><br><span class="line">resp.json()</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½“éªŒåˆ é™¤æ¥å£</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">resp = requests.delete(<span class="string">&quot;http://&lt;ecs_ip&gt;:8000/v1/devices&quot;</span>, json=&#123;<span class="string">&quot;ids&quot;</span>:[<span class="string">&quot;3116641919&quot;</span>, <span class="string">&quot;94791787847&quot;</span>, <span class="string">&quot;1234567890&quot;</span>]&#125;)</span><br><span class="line">resp.json()</span><br><span class="line"><span class="built_in">cat</span> exp_pyms_data/device.csv  <span class="comment">#æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯æ˜¯å¦è¢«åˆ é™¤</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½“éªŒæ·»åŠ è®¾å¤‡æ¥å£</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">resp = requests.post(</span><br><span class="line">    <span class="string">&quot;htpp://&lt;ecs_ip&gt;:8000/v1/devices&quot;</span>,</span><br><span class="line">    json=&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;test-name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;controller&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hardware&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;model&quot;</span>: <span class="string">&quot;test-model&quot;</span>,</span><br><span class="line">            <span class="string">&quot;sn&quot;</span>: <span class="string">&quot;test-sn&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;software&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;version&quot;</span>: <span class="string">&quot;0.1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;last_update&quot;</span>: <span class="string">&quot;2023-08-06 20:00:00&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;nic&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;wifi&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;mac&quot;</span>: <span class="string">&quot;12:34:56:78:9a:bc&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;ipv4&quot;</span>: <span class="string">&quot;192.168.1.2&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;online&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">resp.json()</span><br><span class="line"><span class="built_in">cat</span> exp_pyms_data/device.csv  <span class="comment">#æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯æ˜¯å¦æˆåŠŸæ·»åŠ </span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½“éªŒæ›´æ–°è®¾å¤‡ä¿¡æ¯æ¥å£</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">resp = requests.put(</span><br><span class="line">    <span class="string">&quot;http://127.0.0.1:8000/v1/devices&quot;</span>,</span><br><span class="line">    json=&#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;0922282528&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;new-name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;software&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;version&quot;</span>: <span class="string">&quot;0.5&quot;</span>,</span><br><span class="line">            <span class="string">&quot;last_update&quot;</span>: <span class="string">&quot;2023-08-06 10:00:00&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;status&quot;</span>: <span class="string">&quot;offline&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">resp.json()</span><br><span class="line"><span class="built_in">cat</span> exp_pyms_data/device.csv  <span class="comment">#æŸ¥çœ‹æ˜¯å¦æˆåŠŸæ›´æ–°è®¾å¤‡ä¿¡æ¯</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#3-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="3.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>3.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p>â€‹	è¯¥å®éªŒæš‚æœªé‡åˆ°é—®é¢˜</p>
<h3 id="4-åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆFlowçš„Python-WebæœåŠ¡æ„å»ºä¸éƒ¨ç½²"><a href="#4-åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆFlowçš„Python-WebæœåŠ¡æ„å»ºä¸éƒ¨ç½²" class="headerlink" title="4. åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆFlowçš„Python WebæœåŠ¡æ„å»ºä¸éƒ¨ç½²"></a>4. åŸºäºé˜¿é‡Œäº‘äº‘æ•ˆFlowçš„Python WebæœåŠ¡æ„å»ºä¸éƒ¨ç½²</h3><h4 id="4-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#4-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="4.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>4.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     æŒæ¡Pythonè™šæ‹Ÿç¯å¢ƒçš„åº”ç”¨å’Œæ“ä½œ</p>
<p>â€¢     ç†Ÿç»ƒè¿ç”¨é˜¿é‡Œäº‘äº‘æœåŠ¡å™¨ECSã€é˜¿é‡Œäº‘äº‘æ•ˆä»£ç ç®¡ç†Codeupä¸æµæ°´çº¿Flowï¼Œä»¥åŠé˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ACR</p>
<p>â€¢     æŒæ¡Pythoné¡¹ç›®éƒ¨ç½²çš„å¤šç§æ–¹å¼ï¼Œåˆæ­¥ä½“éªŒæµæ°´çº¿çš„åº”ç”¨æ¨¡å¼</p>
<h4 id="4-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#4-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="4.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>4.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/exp_pyms_demo">exp_pyms_demo <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	ç”¨Xftp 7æŠŠèŒƒä¾‹æœåŠ¡åŒ…ä¸Šä¼ è‡³äº‘ç«¯è§£å‹ï¼Œå¹¶åœ¨ECSæœåŠ¡å™¨ä¸Šçš„è™šæ‹Ÿç¯å¢ƒéƒ¨ç½²èŒƒä¾‹æœåŠ¡</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">tar -xzvf exp_pyms_demo.tar.gz</span><br><span class="line"><span class="built_in">cd</span> exp_pyms_demo</span><br><span class="line">python3 -m venv exp_venv</span><br><span class="line"><span class="built_in">source</span> exp_env/bin/activate</span><br><span class="line">pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure></div>

<p>â€‹	å¯åŠ¨Python WebæœåŠ¡ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">python3 server.py</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨æœ¬åœ°æµè§ˆå™¨è®¿é—®<code>&lt;ECS_IP&gt;:8000/</code>ï¼ŒæŸ¥çœ‹æœåŠ¡é¡µé¢è¾“å‡º</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc70cfae4.jpg" alt="img"></p>
<p>â€‹	ç¡®è®¤æ— è¯¯ååœ¨ç»ˆç«¯è¾“å…¥<code>Ctrl + C</code>åœæ­¢æœåŠ¡ï¼Œé€€å‡ºè™šæ‹Ÿç¯å¢ƒvenvå¹¶åˆ é™¤è™šæ‹Ÿç›®å½•</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">deactivate</span><br><span class="line"><span class="built_in">rm</span> -r exp_venv</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åœ¨exp_pyms_demoç›®å½•ä¸‹åˆ›å»ºDockerfileæ–‡ä»¶ï¼Œå°†Python WebæœåŠ¡èŒƒä¾‹ä»£ç æ‰“åŒ…è¿›å®¹å™¨é•œåƒ</p>
<div class="highlight-container" data-rel="Dockerfile"><figure class="iseeu highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸºäºPython æœ€æ–°åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.10</span>-slim-buster</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;&lt;yud0u@qq.com&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…Pythonåº“</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; pip3 install -r requirements.txt</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># æ¸…ç† apt è½¯ä»¶åŒ…ç¼“å­˜</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶å½“å‰æ–‡ä»¶å¤¹ä¸­å…¨éƒ¨æ–‡ä»¶åˆ°é•œåƒä¸­</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²æœåŠ¡ç«¯å£ 8000</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;python3&quot;</span>, <span class="string">&quot;server.py&quot;</span>]</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨<code>docker build</code>å‘½ä»¤æ„å»ºé•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t exp_pyms_demo .</span><br><span class="line">docker images  <span class="comment">#æŸ¥è¯¢é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å¯åŠ¨ç›¸å…³å®¹å™¨</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --restart=always --name exp_pyms_demo -p 8000:8000 exp_pyms_demo</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åŒæ ·åœ¨æµè§ˆå™¨ä¸Šè®¿é—®<code>http://&lt;ECS_IP&gt;:8000/</code>ï¼ŒæŸ¥çœ‹æœåŠ¡é¡µé¢è¾“å‡ºæ¥éªŒè¯ã€‚æˆ–è€…ç”¨<code>curl</code>å‘½ä»¤æ¥éªŒè¯	</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://127.0.0.l:8000</span><br></pre></td></tr></table></figure></div>

<p>â€‹	éªŒè¯æˆåŠŸååœæ­¢ã€åˆ é™¤å®¹å™¨åï¼Œåˆ é™¤é•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop exp_pyms_demo</span><br><span class="line">docker <span class="built_in">rm</span> exp_pyms_demo</span><br><span class="line">docker rmi exp_pyms_demo</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æœ¬åœ°ä¸‹è½½èŒƒä¾‹æœåŠ¡åŒ…åï¼Œè¿›è¡Œæœ¬åœ°ä»“åº“åˆå§‹åŒ–å¹¶å…³è”è¿œç¨‹ä»“åº“,åˆ›å»ºvenvåˆ†æ”¯ä¸ºåç»­å®éªŒåšå‡†å¤‡</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin git@codeup.aliyun.com:66e7c39e4244e4202214531d/exp_pyms_demo.git</span><br><span class="line">git pull origin master</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;init&quot;</span></span><br><span class="line">git push -u origin master</span><br><span class="line">git chechout -b venv  <span class="comment">#åˆ›å»ºvenvåˆ†æ”¯å¹¶åˆ‡æ¢</span></span><br><span class="line">git push --set-upstream origin venv  <span class="comment">#åˆ›å»ºè¿œç¨‹ä»“åº“ï¼Œä¸æœ¬åœ°ä»“åº“å…³è”</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	é…ç½®äº‘æ•ˆFlowä»¥æ”¯æŒECSè™šæ‹Ÿç¯å¢ƒéƒ¨ç½²ï¼Œé€‰æ‹©ä»£ç æºä¸ºCodeupçš„ä»£ç ä»“åº“exp_pyms_demoï¼Œé»˜è®¤åˆ†æ”¯ä¸ºvenvï¼Œå°†ECSæœåŠ¡å™¨é…ç½®åˆ°ä¸»æœºéƒ¨ç½²ä¸­ï¼Œè¿è¡Œæµæ°´çº¿</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc725cd6b.png" alt="image-20250115214222161"></p>
<p>â€‹	æ­¤æ—¶å¯ä»¥é€šè¿‡<code>curl</code>å‘½ä»¤æµ‹è¯•æœåŠ¡æ¥å£æ˜¯å¦å¯è®¿é—®ï¼Œæˆ–é€šè¿‡æµè§ˆå™¨è®¿é—®<code>&lt;ECS_IP&gt;:8000/</code></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://127.0.0.1:8000</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹devices.csvï¼Œæ·»åŠ ä¸€æ¡è®¾å¤‡ä¿¡æ¯ï¼Œå¹¶æ¨é€è‡³è¿œç¨‹ä»“åº“è§¦å‘æµæ°´çº¿æ‰§è¡Œï¼Œç”¨æµè§ˆå™¨é‡æ–°è®¿é—®</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc6fc5160.jpg" alt="img"></p>
<p>â€‹	å¯ä»¥çœ‹åˆ°å·²æ˜¾ç¤ºæ·»åŠ çš„è®¾å¤‡ä¿¡æ¯ï¼Œå…³é—­èŒƒä¾‹æœåŠ¡</p>
<p>â€‹	å°†ä¹‹å‰å‡†å¤‡å¥½çš„Dockerfileæ–‡ä»¶ç”¨äºåœ¨æµæ°´çº¿ä¸­åˆ¶ä½œæ‰¿è½½èŒƒä¾‹æœåŠ¡çš„Dockeré•œåƒ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git add Dockerfile</span><br><span class="line">git commit -m <span class="string">&quot;docs: Add Dockerfile&quot;</span></span><br><span class="line">git push --set-upsstream origin docker</span><br></pre></td></tr></table></figure></div>

<p>â€‹	é‡æ–°é…ç½®å¥½æµæ°´çº¿æºåè¿è¡Œæµæ°´çº¿ï¼Œæ”¹ç”¨Dockeréƒ¨ç½²</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc6ec3a37.gif" alt="img"></p>
<p>â€‹	æ ¹æ®ã€ŒPythonä»£ç æ‰«ç é˜¶æ®µã€æ‰€æç¤ºçš„ä¿¡æ¯ï¼Œä¿®æ”¹server.pyå­˜åœ¨çš„æ ¼å¼é—®é¢˜åæäº¤ã€æ¨é€</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc6ecbf63.gif" alt="img"></p>
<h4 id="4-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#4-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="4.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>4.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p><strong>(âœ…ï¼‰æœ¬å®éªŒé‡åˆ°çš„æœ€å¤§é—®é¢˜ä¸ºï¼šDockerfileä¸­æ‹‰å–python:3.10-slim-busterè¶…æ—¶</strong></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc6f76e17.gif" alt="img"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc704af44.gif" alt="img"></p>
<ol>
<li>ï¼ˆâŒï¼‰æ ¹æ®è¯¥é¡µé¢çš„æ™ºèƒ½æ’æŸ¥ï¼Œæˆ‘å°è¯•ä»é˜¿é‡Œäº‘ACRåˆ¶å“ä¸­å¿ƒä¸­æ‹‰å–alinux3&#x2F;pythonæ¥æ›¿ä»£ï¼Œåç»­å‡ºç°ä¸€ç³»åˆ—å¦‚ï¼šapt-getå‘½ä»¤ä¸å­˜åœ¨ï¼Œéœ€æ›¿æ¢æˆapkç­‰é—®é¢˜ï¼Œæœ€åå‘ç°æ˜¯æ“ä½œç³»ç»Ÿä¹‹é—´ä¸å…¼å®¹ï¼Œä¸‹è½½çš„pythonæ˜¯åŸºäºalinux3çš„</li>
</ol>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc719e2bd.gif" alt="img"></p>
<ol start="2">
<li>ï¼ˆâœ…ï¼‰å’¨è¯¢äº†é˜¿é‡Œäº‘åœ¨çº¿å®¢æœåï¼ŒæŠŠã€ŒPythoné•œåƒæ„å»ºã€é…ç½®ä¸­çš„æ„å»ºé›†ç¾¤æ”¹ä¸ºã€Œäº‘æ•ˆä¸­å›½é¦™æ¸¯æ„å»ºé›†ç¾¤ã€ï¼Œå³å¯é¡ºåˆ©æ‹‰å–</li>
</ol>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/15/6787bc723e717.gif" alt="img"></p>
<h3 id="5-åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡è®¾è®¡ä¸ä½“éªŒ"><a href="#5-åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡è®¾è®¡ä¸ä½“éªŒ" class="headerlink" title="5. åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡è®¾è®¡ä¸ä½“éªŒ"></a>5. åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡è®¾è®¡ä¸ä½“éªŒ</h3><h4 id="5-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#5-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="5.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>5.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     ç†è§£å¹¶æŒæ¡å‡½æ•°è®¡ç®—FCçš„è®¾è®¡éƒ¨ç½²è¿‡ç¨‹</p>
<p>â€¢     ç†è§£å¹¶ä½“éªŒå‡½æ•°è®¡ç®—FCçš„å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›</p>
<h4 id="5-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#5-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="5.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>5.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>â€‹	åˆ›å»ºè‡ªå®šä¹‰å…¬å…±å±‚ï¼Œæä¾›<code>Python Sanic</code>ä¾èµ–ï¼Œä»¥ä¾›åç»­å®éªŒè¿›è¡Œã€‚å…¼å®¹è¿è¡Œæ—¶é€‰æ‹©<code>Debian 10</code>ï¼Œæ„å»ºç¯å¢ƒé€‰æ‹©<code>Python 3.10</code>ï¼Œ<code>requirements.txt</code>æ–‡ä»¶ä¸­è¾“å…¥<code>sanic</code></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/17/67893490f2a20.gif" alt="img"></p>
<p>â€‹	åˆ›å»ºWebå‡½æ•°<code>fun-alarm-email-send</code>ï¼Œï¼ŒåŸºäº<code>Sanic</code>æ¡†æ¶ç¼–å†™æ¥å£ä»£ç ï¼Œæ„å»ºå¹¶éƒ¨ç½²å‘Šè­¦é‚®ä»¶å‘é€æ¥å£</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> smtplib <span class="keyword">import</span> SMTP</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line">app = Sanic(<span class="string">&quot;EmailSender&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‚®ä»¶é…ç½® éœ€è¦è‡ªè¡Œä¿®æ”¹ã€‚é‚®ç®±æˆæƒç (password)çš„è·å–ï¼Œè‡ªè¡Œå‰å¾€å¯¹åº”</span></span><br><span class="line">EMAIL_CONFIG = &#123;</span><br><span class="line">    <span class="string">&quot;host&quot;</span>: <span class="string">&quot;smtp.example.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;port&quot;</span>: <span class="number">587</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;your-email@example.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;your-password&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sender&quot;</span>: <span class="string">&quot;your-email@example.com&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_email</span>(<span class="params">recipient, subject, body</span>):</span><br><span class="line">    <span class="comment"># åˆ›å»ºé‚®ä»¶å¯¹è±¡</span></span><br><span class="line">    msg = MIMEMultipart()</span><br><span class="line">    msg[<span class="string">&#x27;From&#x27;</span>] = EMAIL_CONFIG[<span class="string">&quot;sender&quot;</span>]</span><br><span class="line">    msg[<span class="string">&#x27;To&#x27;</span>] = recipient</span><br><span class="line">    msg[<span class="string">&#x27;Subject&#x27;</span>] = subject</span><br><span class="line">    <span class="comment"># æ·»åŠ é‚®ä»¶æ­£æ–‡</span></span><br><span class="line">    msg.attach(MIMEText(body, <span class="string">&#x27;plain&#x27;</span>))</span><br><span class="line">    <span class="comment"># è¿æ¥SMTPæœåŠ¡å™¨</span></span><br><span class="line">    server = SMTP(EMAIL_CONFIG[<span class="string">&quot;host&quot;</span>], EMAIL_CONFIG[<span class="string">&quot;port&quot;</span>])</span><br><span class="line">    server.starttls()  <span class="comment"># å¯åŠ¨TLSåŠ å¯†</span></span><br><span class="line">    server.login(EMAIL_CONFIG[<span class="string">&quot;username&quot;</span>], EMAIL_CONFIG[<span class="string">&quot;password&quot;</span>])</span><br><span class="line">    <span class="comment"># å‘é€é‚®ä»¶</span></span><br><span class="line">    server.send_message(msg)</span><br><span class="line">    <span class="comment"># å…³é—­è¿æ¥</span></span><br><span class="line">    server.quit()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/send&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_email_route</span>(<span class="params">request</span>):</span><br><span class="line">    data = request.json</span><br><span class="line">    recipient = data.get(<span class="string">&quot;recipient&quot;</span>)</span><br><span class="line">    subject = data.get(<span class="string">&quot;subject&quot;</span>)</span><br><span class="line">    body = data.get(<span class="string">&quot;body&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>([recipient, subject, body]):</span><br><span class="line">        <span class="keyword">return</span> json(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Missing required fields&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        send_email(recipient, subject, body)</span><br><span class="line">        <span class="keyword">return</span> json(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Email sent successfully&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> json(&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;, status=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9000</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä»£ç ä¿®æ”¹åï¼Œåˆ é™¤ç°æœ‰çš„<code>å®˜æ–¹å…¬å…±å±‚Flask</code>ï¼Œå¹¶æ·»åŠ è‡ªå®šä¹‰åˆ›å»ºçš„<code>sanic-custom-layer</code>å±‚åéƒ¨ç½²ï¼Œæœ€åéƒ¨ç½²ä»£ç ã€‚åˆ©ç”¨Apifoxå·¥å…·ç¼–å†™å¯¹é‚®ä»¶å‘é€æ¥å£å‘èµ·HTTPæ¥å£</p>
<p>â€‹	<img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/17/6789349115adf.jpg" alt="img"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/17/67893490ef776.jpg" alt="img"></p>
<p>â€‹	ç‚¹è¿›å‡½æ•°è¯¦æƒ…é¡µé¢çš„<code>é…ç½®-è¿è¡Œæ—¶</code>æŒ‰é’®ï¼Œä¿®æ”¹å•å®ä¾‹å¹¶å‘åº¦ä¸º2ï¼Œæœ€åéƒ¨ç½²ã€‚éšååœ¨Apifoxä¸Šç‚¹å‡»<code>è‡ªåŠ¨åŒ–æµ‹è¯•</code>æŒ‰é’®æ–°å¢æµ‹è¯•åœºæ™¯ï¼Œå¡«å†™è¯·æ±‚ä¿¡æ¯åï¼Œå°†çº¿ç¨‹æ•°è®¾ç½®ä¸º10ï¼Œå³åŒæ—¶å¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹æ•°ä¸€å…±10ä¸ªã€‚ç›‘æ§å‡½æ•°è¯¦æƒ…é¡µé¢çš„å®ä¾‹åˆ—è¡¨</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/17/67893491138c4.jpg" alt="img"></p>
<h4 id="5-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#5-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="5.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>5.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p>â€‹	è¯¥å®éªŒæš‚æœªé‡åˆ°é—®é¢˜</p>
<h3 id="6-åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„äº‘å·¥ä½œæµCloudFlowè®¾è®¡ä¸ä½“éªŒ"><a href="#6-åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„äº‘å·¥ä½œæµCloudFlowè®¾è®¡ä¸ä½“éªŒ" class="headerlink" title="6. åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„äº‘å·¥ä½œæµCloudFlowè®¾è®¡ä¸ä½“éªŒ"></a>6. åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„äº‘å·¥ä½œæµCloudFlowè®¾è®¡ä¸ä½“éªŒ</h3><h4 id="6-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#6-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="6.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>6.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     ç†è§£å¹¶æŒæ¡é˜¿é‡Œäº‘CloudFlowçš„åŸºæœ¬æ¦‚å¿µï¼ŒåŠå…¶ä¸å‡½æ•°è®¡ç®—ç‚¹çš„å¯è§†åŒ–ç¼–æ’å·¥å…·ï¼Œèƒ½å¤ŸæŒ‰éœ€è®¾è®¡CloudFlowï¼Œé€šè¿‡ç¼–æ’å¤šä¸ªå‡½æ•°è®¡ç®—çš„è‡ªåŠ¨æ‰§è¡Œå·¥ä½œæµï¼Œä»è€Œæ„å»ºæœåŠ¡æ¥å£</p>
<h4 id="6-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#6-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="6.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>6.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>â€‹	åœ¨<a class="link" href="https://ram.console.aliyun.com/roles%E4%B8%AD%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2%EF%BC%8C%E5%88%86%E9%85%8D%E7%9A%84%E6%9D%83%E9%99%90%E5%8C%85%E6%8B%AC%EF%BC%9A%60AliyunFCFullAccess%60%E3%80%81%60AliyunFnFFullAccess%60%E3%80%81%60AliyunEventBridgeFullAccess%60">https://ram.console.aliyun.com/rolesä¸­åˆ›å»ºè§’è‰²ï¼Œåˆ†é…çš„æƒé™åŒ…æ‹¬ï¼š`AliyunFCFullAccess`ã€`AliyunFnFFullAccess`ã€`AliyunEventBridgeFullAccess` <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	åœ¨<a class="link" href="https://eventbridge.console.aliyun.com/overview%E4%B8%AD%E4%B8%80%E9%94%AE%E6%8E%88%E6%9D%83%EF%BC%8C%E5%AF%B9%60EventBridge%60%E8%BF%9B%E8%A1%8C%E6%8E%88%E6%9D%83">https://eventbridge.console.aliyun.com/overviewä¸­ä¸€é”®æˆæƒï¼Œå¯¹`EventBridge`è¿›è¡Œæˆæƒ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	æ„å»ºåä¸º<code>fun-temperature-and-humidity-data-upload</code>çš„FCå‡½æ•°</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;MyApp&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸©åº¦é˜ˆå€¼</span></span><br><span class="line">t_threshold = (<span class="number">25</span>, <span class="number">28</span>)</span><br><span class="line"><span class="comment"># æ¹¿åº¦é˜ˆå€¼</span></span><br><span class="line">h_threshold = (<span class="number">30</span>, <span class="number">33</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_upload</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.json</span><br><span class="line">        sn = data.get(<span class="string">&quot;sn&quot;</span>)</span><br><span class="line">        temperature = data.get(<span class="string">&quot;temperature&quot;</span>)</span><br><span class="line">        humidity = data.get(<span class="string">&quot;humidity&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>([sn, temperature, humidity]):</span><br><span class="line">            <span class="keyword">return</span> json(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Missing required fields&quot;</span>&#125;, status=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆ¤æ–­æ¸©æ¹¿åº¦æ˜¯å¦è¶…å‡ºé˜ˆå€¼</span></span><br><span class="line">        t_out_flag = <span class="keyword">not</span> (t_threshold[<span class="number">0</span>] &lt;= temperature &lt;= t_threshold[<span class="number">1</span>])</span><br><span class="line">        h_out_flag = <span class="keyword">not</span> (h_threshold[<span class="number">0</span>] &lt;= humidity &lt;= h_threshold[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        email_body = generate_email_body(sn, temperature, humidity, t_threshold, h_threshold)</span><br><span class="line">        res = &#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: <span class="number">1</span> <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å¼‚å¸¸&quot;</span> <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="string">&quot;æ­£å¸¸&quot;</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="comment"># éœ€è¦è‡ªå®šæ›¿æ¢æˆæ”¶ä»¶äººé‚®ç®±åœ°å€</span></span><br><span class="line">                <span class="string">&quot;recipient&quot;</span>: <span class="string">&quot;synx@example.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;subject&quot;</span>: <span class="string">&quot;å‘Šè­¦é‚®ä»¶ - æ¸©æ¹¿åº¦å¼‚å¸¸&quot;</span>,</span><br><span class="line">                <span class="string">&quot;body&quot;</span>: email_body</span><br><span class="line">            &#125; <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json(res)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> json(&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;, status=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_email_body</span>(<span class="params">sn, temperature, humidity, t_threshold, h_threshold</span>):</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="string">&quot;å‘Šè­¦é€šçŸ¥ï¼š\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;å½“å‰è®¾å¤‡(&#123;sn&#125;)çš„æ¸©æ¹¿åº¦æ•°æ®è¶…å‡ºæ­£å¸¸èŒƒå›´ã€‚\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;è®¾å¤‡æ¸©åº¦ï¼š&#123;temperature&#125;Â°C\n&quot;</span></span><br><span class="line">        <span class="string">&quot;æ¸©åº¦é˜ˆå€¼ï¼š&#123;t_threshold[0]&#125;Â°C - &#123;t_threshold[1]&#125;Â°C\n&quot;</span></span><br><span class="line">        <span class="string">&quot;è®¾å¤‡æ¹¿åº¦ï¼š&#123;humidity&#125;%\n&quot;</span></span><br><span class="line">        <span class="string">&quot;æ¹¿åº¦é˜ˆå€¼ï¼š&#123;h_threshold[0]&#125;% - &#123;h_threshold[1]&#125;%\n&quot;</span></span><br><span class="line">        <span class="string">&quot;è¯·å°½å¿«æ£€æŸ¥è®¾å¤‡å¹¶é‡‡å–ç›¸åº”æªæ–½ã€‚\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;æ—¶é—´ï¼š&#123;datetime.datetime.now().isoformat()&#125;&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9000</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ­¤æ—¶ï¼ŒFCå‡½æ•°åˆ—è¡¨ä¸­åº”è¯¥æœ‰ä¸¤ä¸ªå‡½æ•°</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491a652e6.gif" alt="img"></p>
<p>â€‹	åˆ›å»ºäº‘å·¥ä½œæµï¼Œåœ°åŸŸéœ€ä¸FCæ‰€åœ¨åœ°åŸŸä¿æŒä¸€è‡´ã€‚é‡‡ç”¨å¿«é€Ÿæ¨¡å¼æ¥è®¾ç½®å·¥ä½œæµï¼Œç‚¹å‡»<code>CloudFlow Studio</code>æŒ‰é’®å›åˆ°ç”»å¸ƒç¼–è¾‘é¡µé¢ï¼Œåˆ é™¤å·¥ä½œæµé»˜è®¤åˆ›å»ºçš„Hello Worldï¼Œ å¹¶ä»å·¦ä¾§æ“ä½œæ‹–æ‹½<code>InvokeFunction</code>ä»»åŠ¡çŠ¶æ€åˆ°ç”»å¸ƒä¸Šï¼Œå‘½åä¸º<code>fun-temperature-and-humidity-data-upload</code>ï¼Œå³ä¾§<code>åŸºæœ¬é…ç½®</code>ä¸­åˆ‡æ¢YAMLç¼–è¾‘ï¼Œåœ¨YAMLæ¡†å†…æ·»åŠ <code>body.$: $Input.body</code>ï¼Œç‚¹å‡»ä¿å­˜ã€‚åœ¨è¾“å‡ºé…ç½®ä¸­ï¼Œå‹¾é€‰ä½¿ç”¨JsonPathé€‰æ‹©éƒ¨åˆ†å‚æ•°ï¼Œå¡«å…¥<code>$Output.Body</code>ï¼Œç‚¹å‡»ä¿å­˜ã€‚</p>
<p>â€‹	å†æ‹–æ‹½ä¸€ä¸ªInvokeFunctionä»»åŠ¡ï¼Œå‘½åä¸º<code>fun-alarm-email-end</code>ï¼Œé…ç½®YAMLæ•°æ®è´Ÿè½½æ—¶ï¼Œå¡«å†™<code>body.$: $Input.data</code></p>
<p>â€‹	ä»å·¦ä¾§æ‹–æ‹½<code>Choice</code>æ”¾ç½®åœ¨ä¸¤ä¸ª<code>InvokeFunction</code>ä¹‹é—´ï¼Œå†æ‹–æ‹½<code>Succeed</code>è¡¥å…¨æ­¥éª¤ï¼ŒChoice<code>é»˜è®¤è§„åˆ™</code>çš„ä¸‹ä¸ªçŠ¶æ€è®¾ç½®ä¸ºSucceedï¼Œ<code>è‡ªå®šä¹‰ #1</code>å¡ç‰‡æ·»åŠ æ¡ä»¶<code>$Input.status == 1</code>ï¼Œå¹¶è®¾ç½®ä¸‹ä¸ªçŠ¶æ€ä¸ºfun-alarm-email-sendï¼Œç‚¹å‡»ä¿å­˜</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491bd5211.gif" alt="img"></p>
<p>â€‹	ä¿®æ”¹<code>fun-alarm-email-send</code>FCä»£ç ï¼Œä»¥é€‚é…äº‘å·¥ä½œæµè°ƒç”¨</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">Python</span><br><span class="line"><span class="comment"># æºä»£ç ï¼š</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/send&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸ºï¼š</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/send&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>], name=<span class="string">&#x27;send&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/invoke&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>], name=<span class="string">&#x27;invoke&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹<code>fun-temperature-and-humidity-data-upload</code>FCä»£ç </p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æºä»£ç ï¼š</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸ºï¼š</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>], name=<span class="string">&#x27;upload&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/invoke&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>], name=<span class="string">&#x27;invoke&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	è¿”å›<code>å·¥ä½œæµè¯¦æƒ…</code>ç•Œé¢ï¼Œç‚¹å‡»<code>å·¥ä½œæµè°ƒåº¦</code>æ ‡ç­¾é¡µï¼Œåˆ›å»ºå·¥ä½œæµè°ƒåº¦å¹¶é€‰æ‹©<code>HTTP/HTTPSè§¦å‘</code>ï¼Œè¯·æ±‚ç±»å‹é€‰æ‹©<code>HTTPS</code>ï¼Œè¯·æ±‚æ–¹æ³•ä¸º<code>POST</code>ï¼Œè¿”å›å·¥ä½œæµè¯¦æƒ…é¡µé¢åç‚¹å‡»<code>è¯¦æƒ…</code>æŒ‰é’®ï¼Œå¤åˆ¶<code>å…¬ç½‘è®¿é—®åœ°å€</code></p>
<p>â€‹	ä½¿ç”¨Apifoxå¯¹äº‘å·¥ä½œæµå…¬ç½‘å‘èµ·POSTè¯·æ±‚</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491b3305d.jpg" alt="img"></p>
<p>â€‹	è¿”å›<code>å·¥ä½œæµè¯¦æƒ…</code>é¡µé¢ï¼Œç‚¹å‡»<code>æ‰§è¡Œè®°å½•</code>æ ‡ç­¾ï¼Œå°†å‡ºç°ä¸€æ¡æ‰§è¡Œè®°å½•</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491b43413.jpg" alt="img"></p>
<p>â€‹	ç‚¹å‡»<code>è¯¦æƒ…</code>å¯æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæµç¨‹</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491cad09a.jpg" alt="img"></p>
<p>â€‹	ä¿®æ”¹è¯·æ±‚çš„æ•°æ®ï¼Œå°†<code>temperature</code>æ”¹ä¸º40ï¼Œæ¨¡æ‹Ÿè®¾å¤‡å‡ºç°å¼‚å¸¸æƒ…å†µã€‚å‘èµ·è¯·æ±‚åæŸ¥çœ‹è¯¦ç»†æ‰§è¡Œæµç¨‹</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491a6f99a.jpg" alt="img"></p>
<h4 id="6-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#6-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="6.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>6.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p>â€‹	æœ¬å®éªŒä»…é‡åˆ°ä¸€ä¸ª<strong>ä¹Œé¾™</strong>ï¼ŒèŠ±äº†ä¸€ä¸ªå¤šå°æ—¶æ‰debugå‡ºæ¥ï¼šå³åœ¨<code>flow-temperature-and-humidity-data-upload</code>çš„YAMLç¼–è¾‘ä¸­ï¼Œé”™æŠŠ<code>$Input.body</code>å¡«æˆ<code>$Input.Body</code>ï¼Œå¡«å†™äº†å¤§å†™çš„Bã€‚å¯¼è‡´åç»­ç”¨Apifoxå‘èµ·è¯·æ±‚æ—¶è¿”å›ç»“æœä¸èŒƒä¾‹ä¸åŒã€‚è°ƒç”¨äº‘å·¥ä½œæµå†…éƒ¨çš„æµ‹è¯•åŠŸèƒ½ï¼Œè§‚å¯Ÿæ¯ä¸ªInvokeFunctionçš„è¾“å…¥ä¸è¾“å‡ºåï¼Œæ„è¯†åˆ°è¯·æ±‚æ•°æ®ä»æœªè¿›å…¥è¿‡æµç¨‹å½“ä¸­ï¼Œäºæ˜¯é—®é¢˜é”å®šåœ¨ç¬¬ä¸€ä¸ªInvokeFunctionä¸­ï¼Œåœ¨ç ”ç©¶æ•°æ®å¦‚ä½•å¯¼å…¥çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°æ•°æ®æ˜¯æ ¹æ®<code>$Input.body</code>å¯¼å…¥çš„ï¼Œæœ€ç»ˆå‘ç°å¹¶è§£å†³äº†è¿™ä¸ªä¹Œé¾™</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/23/6792491cab23f.gif" alt="img"></p>
<h3 id="7-åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡ä¹‹æ•°æ®åº“è®¿é—®ä¸­é—´ä»¶"><a href="#7-åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡ä¹‹æ•°æ®åº“è®¿é—®ä¸­é—´ä»¶" class="headerlink" title="7. åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡ä¹‹æ•°æ®åº“è®¿é—®ä¸­é—´ä»¶"></a>7. åŸºäºé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—çš„ç®€å•é‚®ä»¶å‘é€æœåŠ¡ä¹‹æ•°æ®åº“è®¿é—®ä¸­é—´ä»¶</h3><h4 id="7-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#7-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="7.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>7.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     æŒæ¡åŸºäºPyMySQLä½¿ç”¨åŸç”ŸSQLå¼€å±•æ•°æ®åº“è¡¨è®¿é—®çš„åŸºæœ¬æ“ä½œ</p>
<p>â€¢     æŒæ¡åŸºäºORMæ¡†æ¶çš„SQLAlchemyå¼€å±•æ•°æ®åº“è¡¨è®¿é—®</p>
<h4 id="7-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#7-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="7.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>7.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>â€‹	è¿›å…¥PolarDBçš„æ§åˆ¶å°ï¼Œåˆ›å»ºé›†ç¾¤åï¼Œä¸ºé›†ç¾¤é…ç½®ç™½åå•ï¼Œå…è®¸æ‰€æœ‰IPè®¿é—®(0.0.0.0&#x2F;0)</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee4f233ad.png" alt="image-20250125215109634"></p>
<p>â€‹	åœ¨åŸºæœ¬ä¿¡æ¯ä¸­æ‰¾åˆ°æ•°æ®åº“è¿æ¥ï¼Œå¤åˆ¶ç§ç½‘åœ°å€ä»¥ä¾›åç»­å®éªŒä½¿ç”¨</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee549c8eb.png" alt="image-20250125215128017"></p>
<p>â€‹	æŸ¥çœ‹å½“å‰ä¸“æœ‰ç½‘ç»œVPCå’Œäº¤æ¢æœºvSwitchä¿¡æ¯ï¼Œä¿è¯åç»­å®éªŒäº§å“å…±ç”¨åŒä¸€å¥—VPCå’ŒvSwitch</p>
<p>â€‹	æ„å»ºFCè‡ªå®šä¹‰å…¬å…±å±‚ï¼Œæä¾›<code>Python sqlalchemy</code>ä¾èµ–ï¼Œå¹¶ä¸º<code>fun-alarm-email-send</code>å‡½æ•°é…ç½®ç›¸åŒçš„VPCå’ŒvSwitch</p>
<p>â€‹	ä½¿ç”¨é˜¿é‡Œäº‘æä¾›çš„äº‘æ•°æ®åº“ç»Ÿä¸€æ§åˆ¶å°(<a class="link" href="https://dmslab.aliyun.com/)%E5%AF%B9PolarDB%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%99%BB%E5%BD%95%E5%AE%9E%E4%BE%8B%E5%90%8E%E8%BF%9B%E5%85%A5%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2%EF%BC%8C%E7%82%B9%E5%87%BB%60%E5%88%9B%E5%BB%BA%E5%BA%93%60%E6%8C%89%E9%92%AE%E6%96%B0%E5%BB%BA%60db_message%60%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%AD%97%E7%AC%A6%E9%9B%86%E9%80%89%E6%8B%A9utf8mb4">https://dmslab.aliyun.com/)å¯¹PolarDBè¿›è¡Œæ“ä½œï¼Œç™»å½•å®ä¾‹åè¿›å…¥ç®¡ç†é¡µé¢ï¼Œç‚¹å‡»`åˆ›å»ºåº“`æŒ‰é’®æ–°å»º`db_message`æ•°æ®åº“ï¼Œå­—ç¬¦é›†é€‰æ‹©utf8mb4 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	æ‰“å¼€<code>db_message</code>çš„SQLæ§åˆ¶å°ï¼Œä½¿ç”¨ä»¥ä¸‹SQLè¯­å¥åˆ›å»º<code>tbl_config</code>è¡¨ç»“æ„</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tbl_config` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;é…ç½®è®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦&#x27;</span>,</span><br><span class="line">  `host` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;é‚®ä»¶æœåŠ¡å™¨çš„ä¸»æœºåœ°å€&#x27;</span>,</span><br><span class="line">  `post` <span class="type">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;é‚®ä»¶æœåŠ¡å™¨çš„ç«¯å£å·&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ç™»å½•é‚®ä»¶æœåŠ¡å™¨çš„ç”¨æˆ·åï¼Œç¤ºä¾‹ï¼š1464935327@qq.com&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ç™»å½•é‚®ä»¶æœåŠ¡å™¨çš„æˆæƒç &#x27;</span>,</span><br><span class="line">  `sender` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;é‚®ä»¶å‘é€äººçš„åœ°å€ï¼Œç¤ºä¾‹ï¼š1464935327@qq.com&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;è®°å½•åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;è®°å½•æœ€åæ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY(`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;é‚®ä»¶é…ç½®è¡¨&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `tbl_config` </span><br><span class="line"> LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure></div>

<p>â€‹	é‡å†™<code>fun-alarm-email-send</code>å‡½æ•°ï¼Œæ–°å»º<code>email_config_service.py</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> custom_json_encoder <span class="keyword">import</span> DateTimeEncoder</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_db_connection</span>():</span><br><span class="line">    <span class="keyword">return</span> pymysql.connect(</span><br><span class="line">        host=<span class="string">&#x27;pc-bp1f07b8tpl06q3qu.mysql.polardb.rds.aliyuncs.com&#x27;</span>,</span><br><span class="line">        port=<span class="number">3306</span>,</span><br><span class="line">        user=<span class="string">&#x27;yudou&#x27;</span>,</span><br><span class="line">        password=<span class="string">&#x27;ZYDzyd917917&#x27;</span>,</span><br><span class="line">        db=<span class="string">&#x27;db_message&#x27;</span>,</span><br><span class="line">        charset=<span class="string">&#x27;utf8mb4&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> connection:</span><br><span class="line">            <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">                cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    INSERT INTO tbl_config (</span></span><br><span class="line"><span class="string">                        host,</span></span><br><span class="line"><span class="string">                        port,</span></span><br><span class="line"><span class="string">                        username,</span></span><br><span class="line"><span class="string">                        password,</span></span><br><span class="line"><span class="string">                        sender) </span></span><br><span class="line"><span class="string">                        VALUES (%s, %s, %s, %s, %s)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>, (data[<span class="string">&#x27;host&#x27;</span>], data[<span class="string">&#x27;port&#x27;</span>], data[<span class="string">&#x27;username&#x27;</span>], data[<span class="string">&#x27;password&#x27;</span>], data[<span class="string">&#x27;sender&#x27;</span>]))</span><br><span class="line">                connection.commit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Config created successfully&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        connection.rollback()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> connection:</span><br><span class="line">            <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">                cursor.execute(<span class="string">&quot;SELECT * FROM tbl_config LIMIT 1&quot;</span>)</span><br><span class="line">                result = cursor.fetchone()</span><br><span class="line">                <span class="keyword">if</span> result:</span><br><span class="line">                    config = &#123;</span><br><span class="line">                        <span class="string">&quot;id&quot;</span>: result[<span class="number">0</span>],</span><br><span class="line">                        <span class="string">&quot;host&quot;</span>: result[<span class="number">1</span>],</span><br><span class="line">                        <span class="string">&quot;port&quot;</span>: result[<span class="number">2</span>],</span><br><span class="line">                        <span class="string">&quot;username&quot;</span>: result[<span class="number">3</span>],</span><br><span class="line">                        <span class="string">&quot;password&quot;</span>: result[<span class="number">4</span>],</span><br><span class="line">                        <span class="string">&quot;sender&quot;</span>: result[<span class="number">5</span>],</span><br><span class="line">                        <span class="string">&quot;create_time&quot;</span>: result[<span class="number">6</span>],</span><br><span class="line">                        <span class="string">&quot;update_time&quot;</span>: result[<span class="number">7</span>],</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> json.loads(json.dumps(config, cls=DateTimeEncoder))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No configuration found&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> get_db_connection <span class="keyword">as</span> connection:</span><br><span class="line">            <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data.get(<span class="string">&quot;id&quot;</span>):</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">&quot;id is required&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                sql = <span class="string">&quot;UPDATE tbl_config SET&quot;</span></span><br><span class="line">                params = []</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">&#x27;host&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;sender&#x27;</span>]:</span><br><span class="line">                    <span class="keyword">if</span> data.get(<span class="string">&quot;key&quot;</span>):</span><br><span class="line">                        sql += <span class="string">f&quot; <span class="subst">&#123;key&#125;</span> = %s,&quot;</span></span><br><span class="line">                        params.append(data[key])</span><br><span class="line">                    </span><br><span class="line">                sql = sql.rstrip(<span class="string">&quot;,&quot;</span>) + <span class="string">&quot; WHERE id = %s&quot;</span></span><br><span class="line">                params.append(data[<span class="string">&quot;id&quot;</span>])</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(params)) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">&quot;Config not found&quot;</span>)</span><br><span class="line">                connection.commit()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Config updated successfully&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        connection.rollback()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> connection:</span><br><span class="line">            <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data.get(<span class="string">&quot;id&quot;</span>):</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">&quot;id is required&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> cursor.execute(<span class="string">&quot;DELETE FROM tbl_config WHERE id = %s&quot;</span>, (data[<span class="string">&quot;id&quot;</span>],)) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">&quot;Config not found&quot;</span>)</span><br><span class="line">                connection.commit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Config deleted successfully&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        connection.rollback()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ–°å»º<code>custom_json_encoder.py</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DateTimeEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, datetme):</span><br><span class="line">            <span class="keyword">return</span> obj.isoformat()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().default(obj)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹<code>app.py</code>ä»£ç </p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json <span class="keyword">as</span> std_json</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> smtplib <span class="keyword">import</span> SMTP</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic,response</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email_config_service <span class="keyword">import</span> (create_config,</span><br><span class="line">                                  delete_config,</span><br><span class="line">                                  read_config,</span><br><span class="line">                                  update_config)</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;EmailSender&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_email</span>(<span class="params">data</span>):</span><br><span class="line">        email_config = <span class="keyword">await</span> read_config(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        msg = MIMEMultipart()</span><br><span class="line">        msg[<span class="string">&#x27;From&#x27;</span>] = email_config[<span class="string">&quot;sender&quot;</span>]</span><br><span class="line">        msg[<span class="string">&#x27;To&#x27;</span>] = data.get(<span class="string">&quot;recipient&quot;</span>)</span><br><span class="line">        msg[<span class="string">&#x27;Subject&#x27;</span>] = data.get(<span class="string">&quot;subject&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg.attach(MIMEText(data.get(<span class="string">&quot;body&quot;</span>), <span class="string">&#x27;plain&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        server = SMTP(email_config[<span class="string">&quot;host&quot;</span>], email_config[<span class="string">&quot;port&quot;</span>])</span><br><span class="line">        server.starttls()</span><br><span class="line">        server.login(email_config[<span class="string">&quot;username&quot;</span>],email_config[<span class="string">&quot;password&quot;</span>])</span><br><span class="line"></span><br><span class="line">        server.send_message(msg)</span><br><span class="line"></span><br><span class="line">        server.quit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Email sent successfully&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/invoke&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_email_route</span>(<span class="params">request</span>):</span><br><span class="line">        action = request.json.get(<span class="string">&quot;action&quot;</span>)</span><br><span class="line">        data = request.json.get(<span class="string">&quot;data&quot;</span>,&#123;&#125;)</span><br><span class="line"></span><br><span class="line">        actions = &#123;</span><br><span class="line">                <span class="string">&quot;create_config&quot;</span>: create_config,</span><br><span class="line">                <span class="string">&quot;read_config&quot;</span>: read_config,</span><br><span class="line">                <span class="string">&quot;update_config&quot;</span>: update_config,</span><br><span class="line">                <span class="string">&quot;delete_config&quot;</span>: delete_config,</span><br><span class="line">                <span class="string">&quot;send_email&quot;</span>: send_email</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        func = actions.get(action)</span><br><span class="line">        <span class="keyword">if</span> func:</span><br><span class="line">                <span class="keyword">return</span> json(<span class="keyword">await</span> func(data))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid action&quot;</span>&#125;,status=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9000</span>, dev=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨Apifoxè¿›è¡Œæµ‹è¯•æ–°å¢æ•°æ®åº“æ•°æ®</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee4e81c3b.png" alt="image-20250125215710922"></p>
<p>â€‹	æ‰“å¼€<code>db_message</code>åº“ä¸­çš„<code>tbl_config</code>è¡¨ï¼Œå¯å‘ç°æ•°æ®å·²å­˜å‚¨</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee4d2e449.png" alt="image-20250125215756245"></p>
<p>â€‹	æµ‹è¯•å‘Šè­¦é‚®ä»¶</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee4d47054.png" alt="image-20250125215813828"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee4fc7f22.png" alt="image-20250125215827190"></p>
<p>â€‹	åŸºäºsqlalchemyé‡å†™<code>email_config_service.py</code></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, DateTime, Integer, String, create_engine, func</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> SQLAlchemyError</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> custom_json_encoder <span class="keyword">import</span> DateTimeEncoder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;tbl_config&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    host = Column(String(<span class="number">255</span>))</span><br><span class="line">    port = Column(Integer)</span><br><span class="line">    username = Column(String(<span class="number">255</span>))</span><br><span class="line">    password = Column(String(<span class="number">255</span>))</span><br><span class="line">    sender = Column(String(<span class="number">255</span>))</span><br><span class="line">    create_time = Column(DateTime, server_default=func.now())</span><br><span class="line">    update_time = Column(DateTime, server_default=func.now(), onupdate=func.now())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_db_connection</span>():</span><br><span class="line">    DB_HOST = <span class="string">&#x27;pc-bp1f07b8tpl06q3qu.mysql.polardb.rds.aliyuncs.com&#x27;</span></span><br><span class="line">    DB_PORT = <span class="number">3306</span></span><br><span class="line">    DB_USER = <span class="string">&#x27;yudou&#x27;</span></span><br><span class="line">    DB_PASSWORD = <span class="string">&#x27;ZYDzyd917917&#x27;</span></span><br><span class="line">    DB_NAME = <span class="string">&#x27;db_message&#x27;</span></span><br><span class="line">    encoded_password = urllib.parse.quote_plus(DB_PASSWORD)</span><br><span class="line">    DATABASE_URL = <span class="string">f&#x27;mysql+pymysql://<span class="subst">&#123;DB_USER&#125;</span>:<span class="subst">&#123;encoded_password&#125;</span>@<span class="subst">&#123;DB_HOST&#125;</span>:<span class="subst">&#123;DB_PORT&#125;</span>/<span class="subst">&#123;DB_NAME&#125;</span>&#x27;</span></span><br><span class="line">    engine = create_engine(DATABASE_URL, echo=<span class="literal">True</span>)</span><br><span class="line">    Session = sessionmaker(bind=engine)</span><br><span class="line">    <span class="keyword">return</span> Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ›å»ºé…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            config = Config(</span><br><span class="line">                host=data[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">                port=data[<span class="string">&#x27;port&#x27;</span>],</span><br><span class="line">                username=data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                password=data[<span class="string">&#x27;password&#x27;</span>],</span><br><span class="line">                sender=data[<span class="string">&#x27;sender&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">            session.add(config)</span><br><span class="line">            session.commit()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Config created successfully&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            session.rollback()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯»å–é…ç½®ï¼Œæ­¤å¤„ä»…åšæœ€ç®€å•çš„æŸ¥è¯¢ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡ŒæŸ¥è¯¢&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            config = session.query(Config).first()</span><br><span class="line">            <span class="keyword">if</span> config:</span><br><span class="line">                config_dict = &#123;</span><br><span class="line">                    <span class="string">&quot;id&quot;</span>: config.<span class="built_in">id</span>,</span><br><span class="line">                    <span class="string">&quot;host&quot;</span>: config.host,</span><br><span class="line">                    <span class="string">&quot;port&quot;</span>: config.port,</span><br><span class="line">                    <span class="string">&quot;username&quot;</span>: config.username,</span><br><span class="line">                    <span class="string">&quot;password&quot;</span>: config.password,</span><br><span class="line">                    <span class="string">&quot;sender&quot;</span>: config.sender,</span><br><span class="line">                    <span class="string">&quot;create_time&quot;</span>: config.create_time,</span><br><span class="line">                    <span class="string">&quot;update_time&quot;</span>: config.update_time</span><br><span class="line">                &#125;</span><br><span class="line">                encoded_result = json.dumps(config_dict, cls=DateTimeEncoder)</span><br><span class="line">                <span class="keyword">return</span> json.loads(encoded_result)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No configuration found&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            session.rollback()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ›´æ–°é…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            config = Config(</span><br><span class="line">                host=data[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">                port=data[<span class="string">&#x27;port&#x27;</span>],</span><br><span class="line">                username=data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                password=data[<span class="string">&#x27;password&#x27;</span>],</span><br><span class="line">                sender=data[<span class="string">&#x27;sender&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">            session.add(config)</span><br><span class="line">            session.commit()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Config updated successfully&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            session.rollback()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_config</span>(<span class="params">data</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ é™¤é…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> get_db_connection() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            config_id = data.get(<span class="string">&#x27;id&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> config_id:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;id is required&quot;</span>)</span><br><span class="line">            config = session.query(Config).<span class="built_in">filter</span>(Config.<span class="built_in">id</span> == config_id).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> config:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Config not found&quot;</span>)</span><br><span class="line">            session.delete(config)</span><br><span class="line">            session.commit()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Config deleted successfully&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            session.rollback()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åŒä¸Šè¿›è¡Œæµ‹è¯•ï¼Œç»“æœåº”è¯¥ä¸å˜</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794ee5091978.png" alt="image-20250125215934920"></p>
<h4 id="7-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#7-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="7.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>7.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p>â€‹	è¯¥å®éªŒæš‚æœªé‡åˆ°é—®é¢˜</p>
<h3 id="8-åŸºäºé˜¿é‡Œäº‘Serverlessåº”ç”¨å¼•æ“çš„æœåŠ¡éƒ¨ç½²è¿ç§»"><a href="#8-åŸºäºé˜¿é‡Œäº‘Serverlessåº”ç”¨å¼•æ“çš„æœåŠ¡éƒ¨ç½²è¿ç§»" class="headerlink" title="8. åŸºäºé˜¿é‡Œäº‘Serverlessåº”ç”¨å¼•æ“çš„æœåŠ¡éƒ¨ç½²è¿ç§»"></a>8. åŸºäºé˜¿é‡Œäº‘Serverlessåº”ç”¨å¼•æ“çš„æœåŠ¡éƒ¨ç½²è¿ç§»</h3><h4 id="8-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#8-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="8.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>8.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     ç†Ÿç»ƒè¿ç”¨äº‘æ•ˆCodeupä»£ç ä»“åº“çš„ä½¿ç”¨</p>
<p>â€¢     ç†è§£å¹¶æŒæ¡é˜¿é‡Œäº‘Serverlessåº”ç”¨å¼•æ“éƒ¨ç½²åº”ç”¨çš„æ–¹æ³•</p>
<h4 id="8-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#8-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="8.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>8.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/user_admin">user_admin <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/device_control">device_control <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	å°†ä»¥ä¸Šç”¨æˆ·ç®¡ç†æœåŠ¡ä»£ç ä¸è®¾å¤‡ç®¡ç†æœåŠ¡ä»£ç ä¸Šä¼ åˆ°äº‘æ•ˆCodeup</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7ea8a03e.png" alt="image-20250125224215016"></p>
<p>â€‹	ä¿®è®¢user-adminä¸­application.ymlçš„ä»£ç ã€‚(12<del>14è¡Œ)ä¸­MySQLæ•°æ®åº“é…ç½®æ›´æ”¹ä¸ºPolarDB MySQLçš„å†…ç½‘è®¿é—®åœ°å€åŠå¯¹åº”çš„ç”¨æˆ·åå¯†ç ã€‚(42</del>44è¡Œ)ä¸­Redisæ•°æ®åº“é…ç½®ä¸ºRedisæ•°æ®åº“é…ç½®ä¿¡æ¯</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7ea4aadd.png" alt="image-20250125224225824"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7f1c1909.png" alt="image-20250125224243501"></p>
<p>â€‹	æ‰“å¼€deviceçš„ä»£ç ï¼Œä¿®æ”¹server-config.iniæ–‡ä»¶ä¸­MySQLæ•°æ®åº“é…ç½®ä¸ºPolarDB MySQLçš„å†…ç½‘è®¿é—®åœ°å€åŠå…¶å¯¹åº”çš„ç”¨æˆ·åå¯†ç ã€‚<code>callback_url</code>æ›¿æ¢ä¸ºCloudFlowçš„å†…ç½‘è§¦å‘åœ°å€</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7ec74634.png" alt="image-20250125224256334"></p>
<p>â€‹	è¿›å…¥é˜¿é‡Œäº‘DMSæ§åˆ¶å°ï¼Œåœ¨PolarDB MySQLæ•°æ®åº“ä¸­åˆ›å»º<code>db_user_admin</code>æ•°æ®åº“ï¼Œç‚¹å‡»å·¦ä¾§å¸¸ç”¨åŠŸèƒ½-æ•°æ®å¯¼å…¥ï¼Œé€‰æ‹©æ‰¹é‡æ•°æ®å¯¼å…¥ï¼Œæ•°æ®åº“é€‰æ‹©<code>db_user_admin</code>ï¼Œæ–‡ä»¶ç±»å‹ä¸ºSQLè„šæœ¬ï¼Œæœ€åä¸Šä¼ deviced_controlçš„<code>init.sql</code>æ–‡ä»¶</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7ed1a674.png" alt="image-20250125224308225"></p>
<p>â€‹	ä¿®æ”¹<code>fun-temperature-and-humidity-data-upload</code>FCå‡½æ•°</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸæ¥æ¸©æ¹¿åº¦æ•°æ®ä¸ŠæŠ¥FCçš„resæ•°æ®ç»“æ„å¦‚ä¸‹</span></span><br><span class="line">res = &#123;</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="number">1</span> <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å¼‚å¸¸&quot;</span> <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="string">&quot;æ­£å¸¸&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="comment"># éœ€è¦è‡ªå®šè½¬æ¢æˆæ”¶ä»¶äººé‚®ç®±åœ°å€</span></span><br><span class="line">        <span class="string">&quot;recipient&quot;</span>: <span class="string">&quot;1464935327@qq.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;subject&quot;</span>: <span class="string">&quot;å‘Šè­¦é‚®ä»¶ - æ¸©æ¹¿åº¦å¼‚å¸¸&quot;</span>,</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: <span class="string">&quot;email_body&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åº”è¯¥ä¿®è®¢ä¸ºä»¥ä¸‹æ ¼å¼</span></span><br><span class="line">res = &#123;</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="number">1</span> <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å¼‚å¸¸&quot;</span> <span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="string">&quot;æ­£å¸¸&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;send_email&quot;</span>,</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">            <span class="comment"># éœ€è¦è‡ªå®šè½¬æ¢æˆæ”¶ä»¶äººé‚®ç®±åœ°å€</span></span><br><span class="line">            <span class="string">&quot;recipient&quot;</span>: <span class="string">&quot;1464935327@qq.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;subject&quot;</span>: <span class="string">&quot;å‘Šè­¦é‚®ä»¶ - æ¸©æ¹¿åº¦å¼‚å¸¸&quot;</span>,</span><br><span class="line">            <span class="string">&quot;body&quot;</span>: <span class="string">&quot;email_body&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t_out_flag <span class="keyword">or</span> h_out_flag <span class="keyword">else</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	è¿›å…¥SAEæ§åˆ¶å°åˆ›å»º<code>Webåº”ç”¨</code>ï¼ŒVPCä¸vSwitchä¸å˜ï¼Œä»£ç ä»“åº“ç±»å‹é€‰æ‹©Codeupï¼Œä»“åº“é€‰æ‹©serverless&#x2F;user-admin</p>
<pre><code> å¯åŠ¨å‘½ä»¤å¦‚ä¸‹è®¾ç½®ï¼š
</code></pre>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">java -jar target/user_admin-<span class="number">2024.j</span>ar</span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7ecad7bc.png" alt="image-20250125222818655"></p>
<p>â€‹	ä½¿ç”¨Apifoxå¯¹User-Adminç™»å½•æ¥å£(<code>POST /login/account</code>)å‘èµ·è¯·æ±‚</p>
<p>â€‹	è¯·æ±‚å®ä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line">POST https<span class="punctuation">:</span><span class="comment">//cn-hanger-admin-hvryfblqme.cn-hangzhou.sae.run/login/account</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yudou&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å“åº”ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ“ä½œæ‰§è¡ŒæˆåŠŸ&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;65086510285720102&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	åŒç†ï¼ŒåŸºäºSAEéƒ¨ç½²Device ControlæœåŠ¡ã€‚è®¾ç½®å¯åŠ¨å‘½ä»¤ä¸ºå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">python server.py</span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7ee84db5.png" alt="image-20250125223132687"></p>
<p>â€‹	ä½¿ç”¨Apifoxå¯¹Device-Controlçš„è®¾å¤‡æ·»åŠ æ¥å£(<code>POST /devices</code>)å‘èµ·è¯·æ±‚</p>
<p>â€‹	è¯·æ±‚ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line">POST https<span class="punctuation">:</span><span class="comment">//cn-hang-control-rcuipmgcxu.cn-hangzhou.sae.run</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ¸©æ¹¿åº¦è®¾å¤‡&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SNTAH&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;passwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å“åº”ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è®¾å¤‡ä¿¡æ¯æ·»åŠ æˆåŠŸï¼&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/device_client">device_client <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	ä»¥ä¸Šä¸ºæ¨¡æ‹Ÿè®¾å¤‡å®¢æˆ·ç«¯ä»£ç ç¤ºä¾‹ï¼Œè®¾å¤‡å®¢æˆ·ç«¯ç”¨äºæ¨¡æ‹ŸçœŸå®è®¾å¤‡ï¼Œæ„é€ æ¸©æ¹¿åº¦æ•°æ®å¹¶å®šæœŸé€šè¿‡WebSocketé€šé“ä¸Šä¼ æ•°æ®è‡³Device-Control</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºDevice - Controlåº”ç”¨çš„åœ°å€(æ³¨æ„ï¼šä¸éœ€è¦https://ï¼Œåªéœ€è¦åŸŸå) </span></span><br><span class="line"><span class="comment"># ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‰é¢æ­¥éª¤åˆ›å»ºçš„è®¾å¤‡sn </span></span><br><span class="line"><span class="comment"># ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è¯¥è®¾å¤‡çš„å¯†ç  </span></span><br><span class="line">(venv)$ python client.py ws://&lt;your_sae_domain&gt;/devices/auth/ws SNT AH 123456 </span><br><span class="line"></span><br><span class="line">INFO:root:æˆåŠŸè¿æ¥åˆ° ws://&lt;your_sae_domain&gt;/devices/auth/ws? sn=SNT AH&amp;passwd=123456 </span><br><span class="line"></span><br><span class="line">REC:èº«ä»½éªŒè¯æˆåŠŸ </span><br><span class="line">REC:&#123;<span class="string">&quot;sn&quot;</span>:<span class="string">&quot;SNT AH&quot;</span>,<span class="string">&quot;temperature&quot;</span>:26.15,<span class="string">&quot;humidity&quot;</span>:31.97&#125; </span><br><span class="line">REC:&#123;<span class="string">&quot;sn&quot;</span>:<span class="string">&quot;SNT AH&quot;</span>,<span class="string">&quot;temperature&quot;</span>:25.25,<span class="string">&quot;humidity&quot;</span>:31.43&#125; </span><br><span class="line">REC:&#123;<span class="string">&quot;sn&quot;</span>:<span class="string">&quot;SNT AH&quot;</span>,<span class="string">&quot;temperature&quot;</span>:26.85,<span class="string">&quot;humidity&quot;</span>:30.08&#125; </span><br><span class="line">REC:&#123;<span class="string">&quot;sn&quot;</span>:<span class="string">&quot;SNT AH&quot;</span>,<span class="string">&quot;temperature&quot;</span>:35.8,<span class="string">&quot;humidity&quot;</span>:27.67&#125; </span><br><span class="line">REC:&#123;<span class="string">&quot;sn&quot;</span>:<span class="string">&quot;SNT AH&quot;</span>,<span class="string">&quot;temperature&quot;</span>:25.46,<span class="string">&quot;humidity&quot;</span>:30.67&#125;</span><br></pre></td></tr></table></figure></div>

<p>â€‹	å‘Device-Controlå‘é€æ¸©æ¹¿åº¦æ•°æ®åï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹CloudFlowçš„äº‘æ•ˆæƒ…å†µï¼Œè‹¥CloudFlowæ­£å¸¸å·¥ä½œï¼Œåœ¨æ¸©æ¹¿åº¦è¶…å‡ºé˜ˆå€¼æ—¶å°†å‘æŒ‡å®šçš„ç®¡ç†å‘˜é‚®ç®±å‘ç”Ÿå‘Šè­¦é‚®ä»¶</p>
<h4 id="8-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#8-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="8.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>8.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p><strong>ï¼ˆâŒï¼‰è¯¥å®éªŒå¹¶æœªå®Œæˆï¼Œåœ¨æµ‹è¯•ä¸¤ä¸ªSAEæœåŠ¡æ—¶é‡åˆ°æ— æ³•è§£å†³çš„bug</strong></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7efcdc6a.png" alt="image-20250125223842250"></p>
<p>â€‹	ä¸Šå›¾ä¸ºuser-adminæœåŠ¡çš„æ—¥å¿—ï¼Œæ˜¾ç¤ºæ— æ³•è¿æ¥åˆ°PolarDB MySQLï¼Œä½†æˆ‘åå¤ç¡®è®¤å„ä¸ªé˜¿é‡Œäº‘äº§å“çš„VPCå’ŒvSwitchéƒ½æ˜¯ä¸€æ ·çš„</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7f03a9ca.png" alt="image-20250125223910346">	<img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6794f7f1ecb69.png" alt="image-20250125223919940"></p>
<p>â€‹	ä»¥ä¸Šä¸ºApifoxæµ‹è¯•æ—¶çš„æŠ¥é”™ï¼Œç¬¬ä¸€ååº”æ˜¯Rediså’ŒPolarDB MySQLåœ°å€å¡«å†™é”™è¯¯ï¼Œæ£€æŸ¥Codeupå†…ä»£ç å‘ç°å¹¶æœªå‡ºé”™ã€‚å†ä¾æ¬¡æ£€æŸ¥å„ä¸ªäº‘äº§å“çš„VPCï¼ŒvSwitchï¼Œä»¥åŠç™½åå•ï¼Œä¹Ÿæœªä¿®å¤è¯¥bugã€‚æœ€åå°è¯•åˆ é™¤<code>user-admin</code>WebæœåŠ¡é‡åšï¼Œè¿˜æ˜¯å‡ºç°ç›¸åŒbug</p>
<h3 id="9-åŸºäºNacosçš„æœåŠ¡æ³¨å†Œä¸é…ç½®éƒ¨ç½²"><a href="#9-åŸºäºNacosçš„æœåŠ¡æ³¨å†Œä¸é…ç½®éƒ¨ç½²" class="headerlink" title="9. åŸºäºNacosçš„æœåŠ¡æ³¨å†Œä¸é…ç½®éƒ¨ç½²"></a>9. åŸºäºNacosçš„æœåŠ¡æ³¨å†Œä¸é…ç½®éƒ¨ç½²</h3><h4 id="9-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"><a href="#9-1-å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½" class="headerlink" title="9.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½"></a>9.1 å®éªŒç›®æ ‡ä¸ç›¸å…³çŸ¥è¯†æŠ€èƒ½</h4><p>â€¢     ç†è§£å¹¶æŒæ¡å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ³¨å†Œä¸å‘ç°æœºåˆ¶çš„åŸºæœ¬åŸç†ï¼Œç›¸å…³ä¸­é—´ä»¶çš„ç³»ç»Ÿå®šä½å’ŒåŠŸèƒ½</p>
<p>â€¢     ç†è§£å¹¶æŒæ¡æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­é—´ä»¶Nacosçš„å…·ä½“åŠŸèƒ½ä¸åº”ç”¨æ¨¡å¼</p>
<h4 id="9-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"><a href="#9-2-å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º" class="headerlink" title="9.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º"></a>9.2 å®éªŒæ­¥éª¤ä¸å¯¹åº”æˆæœå±•ç¤º</h4><p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/user_admin">user_admin <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>ğŸ“‚ï¼š<a class="link" href="https://github.com/SweetYuDou/System-Middleware-and-Cloud-Virtualization/tree/main/device_control">device_control <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>â€‹	åˆ›å»ºACRé•œåƒä»“åº“ï¼Œä½¿ç”¨Dockeræ‹‰å–Nacosé•œåƒï¼Œå¹¶ä¸Šä¼ è‡³é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“ACR</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull nacos</span><br><span class="line"></span><br><span class="line">docker login --username=é±¼è±†YuDou crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com</span><br><span class="line">docker tag [ImageId] crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/nacos:[é•œåƒç‰ˆæœ¬å·]</span><br><span class="line">docker push crpi-n4sctgr4gzd05xye.cn-hangzhou.personal.cr.aliyuncs.com/exp_yd/nacos:[é•œåƒç‰ˆæœ¬å·]</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åœ¨SAEæ§åˆ¶å°åˆ›å»ºå¾®æœåŠ¡ï¼Œåº”ç”¨åç§°ä¸º<code>Nacos</code>ï¼Œä¿è¯VPCï¼ŒvSwitchï¼Œå®‰å…¨ç»„ä¸å…ˆå‰å®éªŒä¿æŒä¸€è‡´ï¼Œæ·»åŠ ç¯å¢ƒå˜é‡<code>MODE=standalone</code>ï¼Œéƒ¨ç½²Nacos</p>
<p>â€‹	å¼€é€šCLBè´Ÿè½½å‡è¡¡åï¼Œç”¨æµè§ˆå™¨è®¿é—®<code>http://&lt;CLBå…¬ç½‘IP&gt;:8848/nacos</code>ï¼Œå³å¯è§‚å¯ŸNacos UIç•Œé¢</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795072e6fc83.png" alt="image-20250125225940154"></p>
<p>â€‹	åœ¨user-adminåŒ…ä¸­æ‰¾åˆ°<strong>pom.xml</strong>ï¼Œæ·»åŠ Nacosçš„ä¾èµ–åæ ‡</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    ...... (çœç•¥ä¹‹å‰çš„ä¾èµ–)</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-discovery-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.3.0-RC<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹<strong>src&#x2F;main&#x2F;resources&#x2F;application.ymlæ–‡ä»¶</strong>ï¼Œæ·»åŠ Nacosé…ç½®ï¼Œå®ç°è‡ªåŠ¨æ³¨å†Œ</p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">nacos:</span></span><br><span class="line">  <span class="attr">discovery:</span></span><br><span class="line">    <span class="attr">server-addr:</span> <span class="number">172.28</span><span class="number">.97</span><span class="number">.37</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">auto-register:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register:</span></span><br><span class="line">      <span class="attr">service-name:</span> <span class="string">user-admin</span></span><br><span class="line">      <span class="attr">ip:</span> <span class="string">https://cn-hanger-admin-hvryfblqme.cn-hangzhou-vpc.sae.run</span></span><br><span class="line">      <span class="attr">ephemeral:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">healthy:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹åæ¨é€ä»£ç è‡³Codeupè§¦å‘è‡ªåŠ¨éƒ¨ç½²ï¼Œè¿›å…¥Nacos UIç•Œé¢å¯ä»¥çœ‹åˆ°user-adminæœåŠ¡å·²æ³¨å†Œ</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/679507285cf1e.png" alt="image-20250125230138535"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795072946ca1.png" alt="image-20250125230228281"></p>
<p>â€‹	ä¿®æ”¹Device-Controlä¸­çš„server.pyä»£ç ï¼Œå®ç°åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å‘Nacosæ³¨å†Œ</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&#x27;before_server_start&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">register_nacos</span>(<span class="params">app, loop</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> nacos</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è‡ªè¡Œæ›¿æ¢ä¸º Nacos å†…ç½‘ipåœ°å€</span></span><br><span class="line">        SERVER_ADDRESSES = <span class="string">&quot;http://172.28.97.37:8848&quot;</span></span><br><span class="line">        <span class="comment"># Nacosæ³¨å†Œçš„ä¿¡æ¯</span></span><br><span class="line">        SERVICE_NAME = <span class="string">&quot;device-control&quot;</span></span><br><span class="line">        <span class="comment"># è‡ªè¡Œæ›¿æ¢ä¸ºSAEä¸­è·å–çš„å†…ç½‘è®¿é—®åœ°å€ï¼Œåªéœ€è¦åŸŸåï¼Œæ— éœ€æºå¸¦https://</span></span><br><span class="line">        IP = <span class="string">&quot;https://cn-hang-control-rcuipmgcxu.cn-hangzhou.sae.run&quot;</span></span><br><span class="line">        PORT = <span class="number">9000</span></span><br><span class="line"></span><br><span class="line">        client = nacos.NacosClient(SERVER_ADDRESSES)</span><br><span class="line">        <span class="comment"># å‘ Nacos æ³¨å†Œå®ä¾‹</span></span><br><span class="line">        client.add_naming_instance(SERVICE_NAME, IP, PORT, ephemeral=<span class="literal">False</span>, healthy=<span class="literal">True</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å‘ Nacos æ³¨å†ŒæˆåŠŸï¼Œæ³¨å†Œä¿¡æ¯ä¸º: <span class="subst">&#123;SERVICE_NAME&#125;</span>, <span class="subst">&#123;IP&#125;</span>, <span class="subst">&#123;PORT&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;å‘ Nacos æ³¨å†Œå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åŒæ—¶ä¿®æ”¹requirements.txtæ–‡ä»¶ï¼Œæ·»åŠ ä¸€è¡Œnacos-python-sdkä¾èµ–</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sanic~=24.6.0</span><br><span class="line">pymysql~=1.1.1</span><br><span class="line">websockets~=13.0.1</span><br><span class="line">requests~=2.32.3</span><br><span class="line">nacos-python-sdk==0.2</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä¿®æ”¹ä»£ç åæ¨é€è‡³Codeupï¼Œè§¦å‘è‡ªåŠ¨éƒ¨ç½²ã€‚æ‰“å¼€Nacos UIç•Œé¢å³å¯éªŒè¯æ˜¯å¦æ³¨å†Œ</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795072dc47b8.png" alt="image-20250125230622890"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/67950729b6272.png" alt="image-20250125230658403"></p>
<p>â€‹	åœ¨éƒ¨ç½²Nacos SAEåº”ç”¨å®ä¾‹çš„ç»ˆç«¯ç¯å¢ƒä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå®ç°é‚®ä»¶å‘é€FCå‡½æ•°è®¡ç®—çš„é™æ€æ³¨å†Œ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">curl --location --request POST <span class="string">&#x27;http://127.0.0.1:8848/nacos/v2/cs/config?group=DEFAULT_GROUP&amp;dataId=serverless.fc.address.email_send&amp;content=https://fun-alaail-send-ylnkfxeuva.cn-hangzhou-vpc.fcapp.run&#x27;</span> </span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/679507299eaa8.png" alt="image-20250125230731235"></p>
<p>â€‹	é…ç½®å®Œæˆåè§‚å¯ŸNacos UIç•Œé¢ï¼Œå¯å‘ç°<code>send_email</code>é…ç½®å·²æˆåŠŸå‘Nacoså‘å¸ƒ</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795072ac94e2.png" alt="image-20250125230838394"></p>
<p>â€‹	åŒç†ï¼Œå°†CloudFlowå·¥ä½œæµçš„è§¦å‘æ¥å£ä»¥é™æ€æ³¨å†Œçš„æ–¹å¼è¿›è¡Œ</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">curl --location --request POST</span><br><span class="line"><span class="string">&#x27;http://127.0.0.1:8848/nacos/v2/cs/config?</span></span><br><span class="line"><span class="string">group=DEFAULT_GROUP&amp;</span></span><br><span class="line"><span class="string">dataId=serverless.fc.address.cloudflare&amp;</span></span><br><span class="line"><span class="string">content=https://1237899087648526.eventbridge.cn-hangzhou-vpc.aliyuncs.com/webhook/putEvents?token=1ced1dfd257949609f8cd8861b0a914bba5389a992f04ac8a17616ba7e360318f463ec2f6fa14a79b4406e8ed277e4eea86fe72c7e384b82a8fa3825705a6a6d&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/67950738046de.png" alt="image-20250125231030892"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795072cd377a.png" alt="image-20250125231042340"></p>
<p>â€‹	æ„å»ºç”¨æˆ·æœåŠ¡FCï¼ŒåŒæ ·é…ç½®ç›¸åŒçš„VPCã€vSwitchï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json, text</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;UserAdminFC&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nacosé…ç½®</span></span><br><span class="line">NACOS_URL = <span class="string">&quot;http://172.28.97.37:8848&quot;</span>  <span class="comment"># è‡ªè¡Œæ›¿æ¢ä¸ºä½ çš„nacoså†…ç½‘åœ°å€</span></span><br><span class="line">SERVICE_NAME = <span class="string">&quot;user-admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å…¨å±€å˜é‡ä¸­å­˜å‚¨user - adminæœåŠ¡çš„å®ä¾‹URLä¿¡æ¯</span></span><br><span class="line">service_instance_url = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_service_instance_url</span>():</span><br><span class="line">        <span class="keyword">global</span> service_instance_url</span><br><span class="line">        <span class="keyword">if</span> service_instance_url:</span><br><span class="line">                <span class="keyword">return</span> service_instance_url</span><br><span class="line"></span><br><span class="line">        params = &#123;</span><br><span class="line">                <span class="string">&quot;serviceName&quot;</span>: SERVICE_NAME,</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.get(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;NACOS_URL&#125;</span>/nacos/v2/ns/instance/list&quot;</span>,</span><br><span class="line">        params=params)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                data = data = response.json().get(<span class="string">&quot;data&quot;</span>,</span><br><span class="line">                &#123;<span class="string">&#x27;hosts&#x27;</span>: []&#125;).get(<span class="string">&#x27;hosts&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>]:</span><br><span class="line">                        service_instance_url = data[<span class="number">0</span>].get(<span class="string">&#x27;ip&#x27;</span>)</span><br><span class="line">                        <span class="keyword">return</span> service_instance_url</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/register/account&quot;</span>,methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">register_account</span>(<span class="params">request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”¨æˆ·æ³¨å†Œ&quot;&quot;&quot;</span></span><br><span class="line">        instance_url = get_service_instance_url()</span><br><span class="line">        <span class="keyword">if</span> instance_url:</span><br><span class="line">                url = <span class="string">f&quot;http://<span class="subst">&#123;instance_url&#125;</span>/register/account&quot;</span></span><br><span class="line">                response = requests.post(url, json=request.json)</span><br><span class="line">                <span class="keyword">return</span> json(response.json())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> text(<span class="string">&quot;Service instance not found&quot;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&#x27;before_server_start&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">setup</span>(<span class="params">app, loop</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åœ¨å¯åŠ¨æ—¶è·å–æœåŠ¡å®ä¾‹ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        instance_url = get_service_instance_url()</span><br><span class="line">        <span class="keyword">if</span> instance_url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Service instance not found&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æˆåŠŸè·å–åˆ°æœåŠ¡å®ä¾‹åœ°å€ï¼š&quot;</span> + instance_url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">        app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9000</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨Apifoxå¯¹User-Admin FCçš„ç”¨æˆ·æ³¨å†Œæ¥å£(<code>POST /register/account</code>)å‘èµ·è¯·æ±‚ï¼Œæ¥å£è¯·æ±‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line">POST https<span class="punctuation">:</span><span class="comment">//useradminfc-zovpsrnfjk.cn-hangzhou.fcapp.run/register/account</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yudou&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å“åº”ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ“ä½œæ‰§è¡ŒæˆåŠŸ&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;65086872090576958&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ„å»ºè®¾å¤‡ç®¡ç†FCä»£ç ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json, text</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;DeviceControlFC&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nacosé…ç½®</span></span><br><span class="line">NACOS_URL = <span class="string">&quot;http://172.28.97.37:8848&quot;</span>  <span class="comment"># è‡ªè¡Œæ›¿æ¢ä¸ºä½ çš„nacoså†…ç½‘åœ°å€</span></span><br><span class="line">SERVICE_NAME = <span class="string">&quot;device-control&quot;</span>  <span class="comment"># æœåŠ¡åç§°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å…¨å±€å˜é‡ä¸­å­˜å‚¨device - controlæœåŠ¡çš„å®ä¾‹URLä¿¡æ¯</span></span><br><span class="line">service_instance_url = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_service_instance_url</span>():</span><br><span class="line">    <span class="keyword">global</span> service_instance_url</span><br><span class="line">    <span class="keyword">if</span> service_instance_url:</span><br><span class="line">        <span class="keyword">return</span> service_instance_url</span><br><span class="line"></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;serviceName&quot;</span>: SERVICE_NAME,</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.get(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;NACOS_URL&#125;</span>/nacos/v2/ns/instance/list&quot;</span>,</span><br><span class="line">        params=params)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        data = response.json().get(<span class="string">&quot;data&quot;</span>, &#123;<span class="string">&#x27;hosts&#x27;</span>: []&#125;).get(<span class="string">&#x27;hosts&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>]:</span><br><span class="line">            service_instance_url = data[<span class="number">0</span>].get(<span class="string">&#x27;ip&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> service_instance_url</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/devices&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_device</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¾å¤‡æ·»åŠ &quot;&quot;&quot;</span></span><br><span class="line">    instance_url = get_service_instance_url()</span><br><span class="line">    <span class="keyword">if</span> instance_url:</span><br><span class="line">        url = <span class="string">f&quot;http://<span class="subst">&#123;instance_url&#125;</span>/devices&quot;</span></span><br><span class="line">        response = requests.post(url, json=request.json)</span><br><span class="line">        <span class="keyword">return</span> json(response.json())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;Service instance not found&quot;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/devices&quot;</span>, ignore_body=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">query_device</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¾å¤‡æŸ¥è¯¢&quot;&quot;&quot;</span></span><br><span class="line">    instance_url = get_service_instance_url()</span><br><span class="line">    <span class="keyword">if</span> instance_url:</span><br><span class="line">        url = <span class="string">f&quot;http://<span class="subst">&#123;instance_url&#125;</span>/devices&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Authorization&quot;</span>: request.headers.get(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.get(url, json=request.json, headers=headers)</span><br><span class="line">        <span class="keyword">return</span> json(response.json())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;Service instance not found&quot;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&#x27;before_server_start&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">setup</span>(<span class="params">app, loop</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åœ¨å¯åŠ¨æ—¶è·å–æœåŠ¡å®ä¾‹ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    instance_url = get_service_instance_url()</span><br><span class="line">    <span class="keyword">if</span> instance_url <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Service instance not found&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æˆåŠŸè·å–åˆ°æœåŠ¡å®ä¾‹åœ°å€ï¼š&quot;</span> + instance_url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9000</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	åŒç†ï¼Œç”¨Apifoxå¯¹Device-Control FCçš„è®¾å¤‡æ·»åŠ æ¥å£(<code>POST /devices</code>)å‘èµ·è¯·æ±‚ï¼Œæ¥å£è¯·æ±‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line">POST https<span class="punctuation">:</span><span class="comment">//device-ontrolfc-rrubtancws.cn-hangzhou.fcapp.run/devices</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ¸©æ¹¿åº¦è®¾å¤‡&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SNTAH&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;passwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ¥å£å“åº”ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è·å–è®¾å¤‡æ·»åŠ æˆåŠŸï¼&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	å¯¹è®¾å¤‡æŸ¥è¯¢æ¥å£(<code>GET /devices</code>)å‘èµ·è¯·æ±‚ï¼Œæ¥å£è¯·æ±‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET https://device-ontrolfc-rrubtancws.cn-hangzhou.fcapp.run/devices</span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ¥å£å“åº”ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è·å–è®¾å¤‡ä¿¡æ¯æˆåŠŸï¼&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ¸©æ¹¿åº¦è®¾å¤‡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SNTAH&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;passwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ„å»ºæ¸©æ¹¿åº¦ä¸šåŠ¡FCï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic, response</span><br><span class="line"><span class="keyword">from</span> sanic.request <span class="keyword">import</span> Request</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;BizFC&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nacosé…ç½®</span></span><br><span class="line">NACOS_URL = <span class="string">&quot;http://172.28.97.37:8848&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_services_from_nacos</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»Nacosè·å–æœåŠ¡åˆ—è¡¨&quot;&quot;&quot;</span></span><br><span class="line">    response = requests.get(<span class="string">f&quot;<span class="subst">&#123;NACOS_URL&#125;</span>/nacos/v2/ns/service/list&quot;</span>)</span><br><span class="line">    data = response.json()</span><br><span class="line">    <span class="keyword">return</span> data[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;services&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_instance_from_nacos</span>(<span class="params">service_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»Nacosè·å–æŒ‡å®šæœåŠ¡çš„å®ä¾‹IP&quot;&quot;&quot;</span></span><br><span class="line">    response = requests.get(<span class="string">f&quot;<span class="subst">&#123;NACOS_URL&#125;</span>/nacos/v2/ns/instance/list?serviceName=<span class="subst">&#123;service_name&#125;</span>&quot;</span>)</span><br><span class="line">    data = response.json()</span><br><span class="line">    hosts = data[<span class="string">&#x27;data&#x27;</span>].get(<span class="string">&#x27;hosts&#x27;</span>, [])</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hosts) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> data[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;hosts&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;ip&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_config_from_nacos</span>(<span class="params">data_id, group</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»Nacosè·å–æŒ‡å®šé…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    response = requests.get(<span class="string">f&quot;<span class="subst">&#123;NACOS_URL&#125;</span>/nacos/v2/cs/config?dataId=<span class="subst">&#123;data_id&#125;</span>&amp;group=<span class="subst">&#123;group&#125;</span>&quot;</span>)</span><br><span class="line">    data = response.json()</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&#x27;data&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> data[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/getServices&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_services</span>(<span class="params">request: Request</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–æœåŠ¡åŠå…¶å®ä¾‹IPï¼Œå¹¶è¿”å›JSONæ ¼å¼çš„æœåŠ¡æ˜ å°„&quot;&quot;&quot;</span></span><br><span class="line">    services = get_services_from_nacos()</span><br><span class="line">    service_map = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> service <span class="keyword">in</span> services:</span><br><span class="line">        instance_ip = get_instance_from_nacos(service)</span><br><span class="line">        service_map[service.replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)] = instance_ip</span><br><span class="line">    <span class="comment"># ä»é™æ€é…ç½®ä¸­è¯»å–</span></span><br><span class="line">    static_services = &#123;</span><br><span class="line">        <span class="string">&quot;message_url&quot;</span>: get_config_from_nacos(<span class="string">&quot;serverless.fc.address.email_send&quot;</span>, <span class="string">&quot;DEFAULT_GROUP&quot;</span>),</span><br><span class="line">        <span class="string">&quot;cloudflow_url&quot;</span>: get_config_from_nacos(<span class="string">&quot;serverless.fc.address.cloudflow&quot;</span>, <span class="string">&quot;DEFAULT_GROUP&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    service_map.update(static_services)</span><br><span class="line">    <span class="keyword">return</span> response.json(service_map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9000</span>)</span><br></pre></td></tr></table></figure></div>

<p>â€‹	ä½¿ç”¨Apifoxå¯¹Biz FCçš„è·å–çš„æ‰€æœ‰æœåŠ¡åœ°å€æ¥å£(<code>GET /getServices</code>)å‘èµ·è¯·æ±‚ï¼Œæ¥å£è¯·æ±‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line">GET  https<span class="punctuation">:</span><span class="comment">//bizfc-cpklnjfjoq.cn-hangzhou.fcapp.run/getServices</span></span><br></pre></td></tr></table></figure></div>

<p>â€‹	æ¥å£å“åº”ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;device_control&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cn-hang-control-rcuipmgcxu.cn-hangzhou.sae.run&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user_admin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cn-hanger-admin-hvryfblqme.cn-hangzhou.sae.run&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config data not exist&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cloudflow_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://1237899087648526.eventbridge.cn-hangzhou.aliyuncs.com/webhook/putEvents?token=1ced1dfd257949609f8cd8861b0a914bba5389a992f04ac8a17616ba7e360318f463ec2f6fa14a79b4406e8ed277e4eea86fe72c7e384b82a8fa3825705a6a6d&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795072e5d52f.png" alt="image-20250125233826811"></p>
<h4 id="9-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"><a href="#9-3-é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·" class="headerlink" title="9.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·"></a>9.3 é‡åˆ°çš„ä¸»è¦é—®é¢˜ã€è§£å†³æ€è·¯å’Œæ”¶è·</h4><p><strong>ï¼ˆâŒï¼‰æœ¬å®éªŒæœªå®Œæˆï¼ŒApifoxæµ‹è¯•ç”¨æˆ·æœåŠ¡FCå’Œè®¾å¤‡ç®¡ç†FCæ—¶è¿”å›çš„å“åº”æ˜¯é”™è¯¯çš„</strong></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/6795073281187.png" alt="image-20250125234026794"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/67950737aa6da.png" alt="image-20250125234035534"></p>
<p>â€‹	åŒæ ·çš„ï¼Œåœ¨å‡ºç°é”™è¯¯åæ£€æŸ¥äº†ä¸€éæ‰€æœ‰äº‘äº§å“VPCã€vSwitché…ç½®ã€‚å‘ç°æ²¡é—®é¢˜åé€‰æ‹©åœ¨å‡½æ•°è®¡ç®—FCäº‘ç«¯ä¸Šè¿›è¡Œæµ‹è¯•ã€‚åœ¨æµ‹è¯•user-admin FCå’Œdevice-control FCæ—¶ï¼Œä»æ—¥å¿—è¾“å‡ºä¸­çœ‹ä¸å‡ºé—®é¢˜æ‰€åœ¨ï¼Œäºæ˜¯æˆ‘å¼€é€šäº†å®æ—¶æ—¥å¿—åŠŸèƒ½</p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/67950739b0486.png" alt="image-20250125234102110"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/67950731e15ec.png" alt="image-20250125234112269"></p>
<p><img lazyload src="/images/loading.svg" data-src="https://www.helloimg.com/i/2025/01/25/67950733a60b4.png" alt="image-20250125234121706"></p>
<p>â€‹	å‘ç°åœ¨æ—¥å¿—ä¸­å¥½åƒæ•´ä¸ªè¯·æ±‚æµç¨‹æ­£å¸¸ï¼Œæ—¥å¿—æ‰“å°â€œæˆåŠŸè·å–åˆ°æœåŠ¡å™¨å®ä¾‹åœ°å€â€ï¼Œè¯´æ˜æˆåŠŸè·å–æœåŠ¡å®ä¾‹ä¿¡æ¯ã€‚ä¸”å®ƒçš„åœ¨çº¿æµ‹è¯•æŠ¥é”™ä¸º404ï¼Œä¸æˆ‘åœ¨Apifoxä¸Šçš„HTTPç 500å¹¶ä¸åŒï¼Œå› æ­¤æ€€ç–‘æ˜¯è¿”å›å“åº”çš„é€”ä¸­å‡ºç°é—®é¢˜ã€‚ä½†æˆ‘æ— ä»ä¸‹æ‰‹debugäº†ï¼Œè¯¢é—®é˜¿é‡Œäº‘åœ¨çº¿å®¢æœä¹Ÿæœªèƒ½è§£å†³</p>
]]></content>
      <categories>
        <category>software-engineering</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Maven</tag>
        <tag>Spring Boot</tag>
        <tag>é˜¿é‡Œäº‘</tag>
        <tag>Serverless</tag>
        <tag>Nacos</tag>
        <tag>Git</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
</search>
